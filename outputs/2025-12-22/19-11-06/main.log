[2025-12-22 19:11:06,190][__main__][INFO] - Using device: cuda
[2025-12-22 19:11:06,192][__main__][INFO] - ====================================================================================================
[2025-12-22 19:11:06,192][__main__][INFO] - GENEFORMER PERTURBATION PIPELINE
[2025-12-22 19:11:06,192][__main__][INFO] - ====================================================================================================
[2025-12-22 19:11:06,192][__main__][INFO] - Experiment: geneformer_perturbation_distributed_test
[2025-12-22 19:11:06,196][__main__][INFO] - 
Configuration:
seed: 42
model:
  name: gf-6L-10M-i2048
  batch_size: 2
  device: cuda:0
data:
  pertpy_data_identifier: norman_2019
  condition_filter: control
  save_tokenized_data: true
  gene_names_column: index
  use_raw_counts: false
  preprocess: true
  normalize: false
  filter_genes: true
  min_genes: 100
  min_cells: 3
  max_cells: 100
  max_genes: 100
perturbation:
  gene_list: null
  num_genes: 5
  perturbation_type: knockout
  selection_method: top_expressed
  perturbation_strength: 2.0
  save_perturbed_data: true
optimization:
  methods:
  - distributed
  batching:
    enabled: true
    batch_size_multiplier: 2
  quantization:
    enabled: true
    dtype: qint8
    calibration_data_size: 32
  onnx:
    enabled: true
    use_gpu: true
    precision: FP16
  distributed:
    enabled: true
    backend: nccl
output:
  dir: outputs
  cache_dir: /scratch
  save_outputs: true
  compression: true
  precision: float32
  save_detailed_comparisons: true
  log_level: INFO
  log_to_file: true
  log_file: pipeline.log
hardware:
  device: auto
  mixed_precision: false
  cudnn_benchmark: true
  empty_cache_between_methods: true
experiment:
  name: geneformer_perturbation_distributed_test
  tags: []
  notes: ''
reproducibility:
  deterministic: true
advanced:
  compile_model: false
  compile_backend: inductor
  continue_on_error: true
validation:
  min_correlation: 0.95
  max_mse: 0.01
  warn_on_threshold: true
  check_nan: true
  check_inf: true

[2025-12-22 19:11:06,196][__main__][INFO] - Loading Geneformer model...
[2025-12-22 19:11:10,291][helical.models.geneformer.model][INFO] - Model finished initializing.
[2025-12-22 19:11:10,291][helical.models.geneformer.model][INFO] - 'gf-6L-10M-i2048' model is in 'eval' mode, on device 'cuda:0' with embedding mode 'cell'.
[2025-12-22 19:11:10,292][__main__][INFO] - Model loaded: gf-6L-10M-i2048
[2025-12-22 19:11:10,292][__main__][INFO] - Loading data: norman_2019
[2025-12-22 19:11:10,294][__main__][INFO] - Found processed data saved to disk.
[2025-12-22 19:11:10,406][__main__][INFO] - Selected 5 genes using method: top_expressed
[2025-12-22 19:11:10,406][__main__][INFO] - Performing perturbation on 5 genes...
[2025-12-22 19:11:10,408][__main__][INFO] - Perturbed data found in cache. Loading from disk.
[2025-12-22 19:11:10,416][__main__][INFO] - Perturbed data found in cache. Loading from disk.
[2025-12-22 19:11:10,424][__main__][INFO] - Perturbed data found in cache. Loading from disk.
[2025-12-22 19:11:10,432][__main__][INFO] - Perturbed data found in cache. Loading from disk.
[2025-12-22 19:11:10,439][__main__][INFO] - Perturbed data found in cache. Loading from disk.
[2025-12-22 19:11:10,446][__main__][INFO] - Perturbations complete.
[2025-12-22 19:11:10,446][__main__][INFO] - 
====================================================================================================
[2025-12-22 19:11:10,446][__main__][INFO] - Running BASELINE (no optimization)...
[2025-12-22 19:11:10,449][__main__][INFO] - Extracting embeddings...
[2025-12-22 19:11:10,449][helical.models.geneformer.model][INFO] - Started getting embeddings:
[2025-12-22 19:11:12,300][helical.models.geneformer.model][INFO] - Finished getting embeddings.
[2025-12-22 19:11:12,300][__main__][INFO] - Extracted embeddings shape: (100, 256)
[2025-12-22 19:11:12,301][__main__][INFO] - Extracting embeddings for perturbations on 5 genes...
[2025-12-22 19:11:12,301][__main__][INFO] - Extraxcting embeddings for perturbed: FAAP20 (type: knockout)
[2025-12-22 19:11:12,301][__main__][INFO] - Extracting embeddings...
[2025-12-22 19:11:12,301][helical.models.geneformer.model][INFO] - Started getting embeddings:
[2025-12-22 19:11:12,677][helical.models.geneformer.model][INFO] - Finished getting embeddings.
[2025-12-22 19:11:12,677][__main__][INFO] - Extracted embeddings shape: (100, 256)
[2025-12-22 19:11:12,677][__main__][INFO] - Extraxcting embeddings for perturbed: SSU72 (type: knockout)
[2025-12-22 19:11:12,677][__main__][INFO] - Extracting embeddings...
[2025-12-22 19:11:12,678][helical.models.geneformer.model][INFO] - Started getting embeddings:
[2025-12-22 19:11:13,050][helical.models.geneformer.model][INFO] - Finished getting embeddings.
[2025-12-22 19:11:13,050][__main__][INFO] - Extracted embeddings shape: (100, 256)
[2025-12-22 19:11:13,050][__main__][INFO] - Extraxcting embeddings for perturbed: MRPL20 (type: knockout)
[2025-12-22 19:11:13,050][__main__][INFO] - Extracting embeddings...
[2025-12-22 19:11:13,050][helical.models.geneformer.model][INFO] - Started getting embeddings:
[2025-12-22 19:11:13,424][helical.models.geneformer.model][INFO] - Finished getting embeddings.
[2025-12-22 19:11:13,424][__main__][INFO] - Extracted embeddings shape: (100, 256)
[2025-12-22 19:11:13,424][__main__][INFO] - Extraxcting embeddings for perturbed: AURKAIP1 (type: knockout)
[2025-12-22 19:11:13,424][__main__][INFO] - Extracting embeddings...
[2025-12-22 19:11:13,424][helical.models.geneformer.model][INFO] - Started getting embeddings:
[2025-12-22 19:11:13,797][helical.models.geneformer.model][INFO] - Finished getting embeddings.
[2025-12-22 19:11:13,797][__main__][INFO] - Extracted embeddings shape: (100, 256)
[2025-12-22 19:11:13,797][__main__][INFO] - Extraxcting embeddings for perturbed: RPL22 (type: knockout)
[2025-12-22 19:11:13,797][__main__][INFO] - Extracting embeddings...
[2025-12-22 19:11:13,798][helical.models.geneformer.model][INFO] - Started getting embeddings:
[2025-12-22 19:11:14,169][helical.models.geneformer.model][INFO] - Finished getting embeddings.
[2025-12-22 19:11:14,169][__main__][INFO] - Extracted embeddings shape: (100, 256)
[2025-12-22 19:11:14,169][__main__][INFO] - Finished getting perturbation results.
[2025-12-22 19:11:14,201][__main__][INFO] - Saved outputs for baseline to outputs/outputs/baseline
[2025-12-22 19:11:14,466][__main__][INFO] - 
====================================================================================================
[2025-12-22 19:11:14,467][__main__][INFO] - Running with DDP DISTRIBUTED optimization...
[2025-12-22 19:11:14,467][__main__][INFO] - Using 4 GPUs with DDP
[2025-12-22 19:11:14,511][__main__][INFO] - Using temporary directory: /scratch/ddp_results_208llz26
[2025-12-22 19:11:14,520][__main__][ERROR] - distributed failed: cannot pickle '_thread.RLock' object
Traceback (most recent call last):
  File "/root/capsule/code/helical-challenge/main.py", line 1373, in run
    perf_metrics, outputs = runner(model, data,
  File "/root/capsule/code/helical-challenge/main.py", line 1059, in run_with_distributed_ddp
    mp.spawn(
  File "/opt/conda/lib/python3.10/site-packages/torch/multiprocessing/spawn.py", line 364, in spawn
    return start_processes(fn, args, nprocs, join, daemon, start_method="spawn")
  File "/opt/conda/lib/python3.10/site-packages/torch/multiprocessing/spawn.py", line 304, in start_processes
    idx, process, tf_name = start_process(i)
  File "/opt/conda/lib/python3.10/site-packages/torch/multiprocessing/spawn.py", line 299, in start_process
    process.start()
  File "/opt/conda/lib/python3.10/multiprocessing/process.py", line 121, in start
    self._popen = self._Popen(self)
  File "/opt/conda/lib/python3.10/multiprocessing/context.py", line 288, in _Popen
    return Popen(process_obj)
  File "/opt/conda/lib/python3.10/multiprocessing/popen_spawn_posix.py", line 32, in __init__
    super().__init__(process_obj)
  File "/opt/conda/lib/python3.10/multiprocessing/popen_fork.py", line 19, in __init__
    self._launch(process_obj)
  File "/opt/conda/lib/python3.10/multiprocessing/popen_spawn_posix.py", line 47, in _launch
    reduction.dump(process_obj, fp)
  File "/opt/conda/lib/python3.10/multiprocessing/reduction.py", line 60, in dump
    ForkingPickler(file, protocol).dump(obj)
TypeError: cannot pickle '_thread.RLock' object
[2025-12-22 19:11:14,521][__main__][INFO] - 
====================================================================================================
[2025-12-22 19:11:14,521][__main__][INFO] - COMPARING OUTPUTS TO BASELINE
[2025-12-22 19:11:14,521][__main__][INFO] - ====================================================================================================
[2025-12-22 19:11:14,522][__main__][INFO] - Performance metrics saved to: outputs/performance_metrics_20251222_191114.csv
[2025-12-22 19:11:14,524][__main__][INFO] - 
====================================================================================================
[2025-12-22 19:11:14,524][__main__][INFO] - PERFORMANCE SUMMARY
[2025-12-22 19:11:14,524][__main__][INFO] - ====================================================================================================
[2025-12-22 19:11:14,527][__main__][INFO] - 
     method  runtime_seconds  cpu_percent    memory_mb  gpu_memory_mb  gpu_utilization  throughput_cells_per_sec  num_cells  num_genes_perturbed                   timestamp extra_optimization
0  baseline         3.722517         88.1  5730.632812      48.404785               19                 26.863546        100                    5  2025-12-22T19:11:14.171397               none

[2025-12-22 19:11:14,527][__main__][INFO] - 
SPEEDUP RELATIVE TO BASELINE:
[2025-12-22 19:11:14,527][__main__][INFO] - --------------------------------------------------
[2025-12-22 19:11:14,527][__main__][INFO] - ====================================================================================================
[2025-12-22 19:11:14,527][__main__][INFO] - 
All outputs saved to: outputs
[2025-12-22 19:11:14,528][__main__][INFO] - 
====================================================================================================
[2025-12-22 19:11:14,528][__main__][INFO] - PIPELINE COMPLETE!
[2025-12-22 19:11:14,528][__main__][INFO] - ====================================================================================================
