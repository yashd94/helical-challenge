[2025-12-22 19:20:14,790][__main__][INFO] - Using device: cuda
[2025-12-22 19:20:14,791][__main__][INFO] - ====================================================================================================
[2025-12-22 19:20:14,792][__main__][INFO] - GENEFORMER PERTURBATION PIPELINE
[2025-12-22 19:20:14,792][__main__][INFO] - ====================================================================================================
[2025-12-22 19:20:14,792][__main__][INFO] - Experiment: geneformer_perturbation_distributed_test
[2025-12-22 19:20:14,796][__main__][INFO] - 
Configuration:
seed: 42
model:
  name: gf-6L-10M-i2048
  batch_size: 2
  device: cuda:0
data:
  pertpy_data_identifier: norman_2019
  condition_filter: control
  save_tokenized_data: true
  gene_names_column: index
  use_raw_counts: false
  preprocess: true
  normalize: false
  filter_genes: true
  min_genes: 100
  min_cells: 3
  max_cells: 100
  max_genes: 100
perturbation:
  gene_list: null
  num_genes: 5
  perturbation_type: knockout
  selection_method: top_expressed
  perturbation_strength: 2.0
  save_perturbed_data: true
optimization:
  methods:
  - distributed
  batching:
    enabled: true
    batch_size_multiplier: 2
  quantization:
    enabled: true
    dtype: qint8
    calibration_data_size: 32
  onnx:
    enabled: true
    use_gpu: true
    precision: FP16
  distributed:
    enabled: true
    backend: nccl
output:
  dir: outputs
  cache_dir: /scratch
  save_outputs: true
  compression: true
  precision: float32
  save_detailed_comparisons: true
  log_level: INFO
  log_to_file: true
  log_file: pipeline.log
hardware:
  device: auto
  mixed_precision: false
  cudnn_benchmark: true
  empty_cache_between_methods: true
experiment:
  name: geneformer_perturbation_distributed_test
  tags: []
  notes: ''
reproducibility:
  deterministic: true
advanced:
  compile_model: false
  compile_backend: inductor
  continue_on_error: true
validation:
  min_correlation: 0.95
  max_mse: 0.01
  warn_on_threshold: true
  check_nan: true
  check_inf: true

[2025-12-22 19:20:14,796][__main__][INFO] - Loading Geneformer model...
[2025-12-22 19:20:18,697][helical.models.geneformer.model][INFO] - Model finished initializing.
[2025-12-22 19:20:18,697][helical.models.geneformer.model][INFO] - 'gf-6L-10M-i2048' model is in 'eval' mode, on device 'cuda:0' with embedding mode 'cell'.
[2025-12-22 19:20:18,698][__main__][INFO] - Model loaded: gf-6L-10M-i2048
[2025-12-22 19:20:18,699][__main__][INFO] - Loading data: norman_2019
[2025-12-22 19:20:18,700][__main__][INFO] - Found processed data saved to disk.
[2025-12-22 19:20:18,833][__main__][INFO] - Selected 5 genes using method: top_expressed
[2025-12-22 19:20:18,833][__main__][INFO] - Performing perturbation on 5 genes...
[2025-12-22 19:20:18,835][__main__][INFO] - Perturbed data found in cache. Loading from disk.
[2025-12-22 19:20:18,842][__main__][INFO] - Perturbed data found in cache. Loading from disk.
[2025-12-22 19:20:18,850][__main__][INFO] - Perturbed data found in cache. Loading from disk.
[2025-12-22 19:20:18,857][__main__][INFO] - Perturbed data found in cache. Loading from disk.
[2025-12-22 19:20:18,865][__main__][INFO] - Perturbed data found in cache. Loading from disk.
[2025-12-22 19:20:18,871][__main__][INFO] - Perturbations complete.
[2025-12-22 19:20:18,871][__main__][INFO] - 
====================================================================================================
[2025-12-22 19:20:18,871][__main__][INFO] - Running BASELINE (no optimization)...
[2025-12-22 19:20:18,950][__main__][ERROR] - Baseline failed: name 'extract_embeddings' is not defined
Traceback (most recent call last):
  File "/root/capsule/code/helical-challenge/main.py", line 1322, in run
    perf_metrics, outputs = self.run_baseline(model, data,
  File "/root/capsule/code/helical-challenge/main.py", line 725, in run_baseline
    embeddings = extract_embeddings(model, data)
NameError: name 'extract_embeddings' is not defined
[2025-12-22 19:20:18,957][__main__][INFO] - 
====================================================================================================
[2025-12-22 19:20:18,957][__main__][INFO] - Running with DDP DISTRIBUTED optimization...
[2025-12-22 19:20:18,957][__main__][INFO] - Using 4 GPUs with DDP
[2025-12-22 19:20:18,994][__main__][INFO] - Using temporary directory: /scratch/ddp_results_rtgvx0dm
[2025-12-22 19:20:19,002][__main__][ERROR] - distributed failed: name 'run_inference_worker' is not defined
Traceback (most recent call last):
  File "/root/capsule/code/helical-challenge/main.py", line 1374, in run
    perf_metrics, outputs = runner(model, data,
  File "/root/capsule/code/helical-challenge/main.py", line 1061, in run_with_distributed_ddp
    run_inference_worker,
NameError: name 'run_inference_worker' is not defined
[2025-12-22 19:20:19,008][__main__][INFO] - 
====================================================================================================
[2025-12-22 19:20:19,008][__main__][INFO] - COMPARING OUTPUTS TO BASELINE
[2025-12-22 19:20:19,008][__main__][INFO] - ====================================================================================================
[2025-12-22 19:20:19,008][__main__][ERROR] - No methods completed successfully
