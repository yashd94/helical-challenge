2025-12-22 23:32:02,437 - __main__ - INFO - ====================================================================================================
2025-12-22 23:32:02,437 - __main__ - INFO - GENEFORMER PERTURBATION PIPELINE
2025-12-22 23:32:02,437 - __main__ - INFO - ====================================================================================================
2025-12-22 23:32:02,438 - __main__ - INFO - Experiment: geneformer_perturbation_distributed_test
2025-12-22 23:32:02,442 - __main__ - INFO - 
Configuration:
seed: 42
model:
  name: gf-6L-10M-i2048
  batch_size: 2
  device: cuda:0
data:
  pertpy_data_identifier: norman_2019
  condition_filter: control
  save_tokenized_data: true
  gene_names_column: index
  use_raw_counts: false
  preprocess: true
  normalize: false
  filter_genes: true
  min_genes: 100
  min_cells: 3
  max_cells: 100
  max_genes: 100
perturbation:
  gene_list: null
  num_genes: 5
  perturbation_type: knockout
  selection_method: top_expressed
  perturbation_strength: 2.0
  save_perturbed_data: true
optimization:
  methods:
  - distributed
  batching:
    enabled: true
    batch_size_multiplier: 2
  quantization:
    enabled: true
    dtype: qint8
    calibration_data_size: 32
  onnx:
    enabled: true
    use_gpu: true
    precision: FP16
  distributed:
    enabled: true
    backend: nccl
output:
  dir: outputs
  cache_dir: /scratch
  save_outputs: true
  compression: true
  precision: float32
  save_detailed_comparisons: true
  log_level: INFO
  log_to_file: true
  log_file: pipeline.log
hardware:
  device: auto
  mixed_precision: false
  cudnn_benchmark: true
  empty_cache_between_methods: true
experiment:
  name: geneformer_perturbation_distributed_test
  tags: []
  notes: ''
reproducibility:
  deterministic: true
advanced:
  compile_model: false
  compile_backend: inductor
  continue_on_error: true
validation:
  min_correlation: 0.95
  max_mse: 0.01
  warn_on_threshold: true
  check_nan: true
  check_inf: true

2025-12-22 23:32:02,442 - __main__ - INFO - Loading Geneformer model...
2025-12-22 23:32:08,780 - __main__ - INFO - Model loaded: gf-6L-10M-i2048
2025-12-22 23:32:08,780 - __main__ - INFO - Loading data: norman_2019
2025-12-22 23:32:08,782 - __main__ - INFO - Found processed data saved to disk.
2025-12-22 23:32:08,894 - __main__ - INFO - Selected 5 genes using method: top_expressed
2025-12-22 23:32:08,894 - __main__ - INFO - Performing perturbation on 5 genes...
2025-12-22 23:32:08,896 - __main__ - INFO - Perturbed data found in cache. Loading from disk.
2025-12-22 23:32:08,905 - __main__ - INFO - Perturbed data found in cache. Loading from disk.
2025-12-22 23:32:08,913 - __main__ - INFO - Perturbed data found in cache. Loading from disk.
2025-12-22 23:32:08,922 - __main__ - INFO - Perturbed data found in cache. Loading from disk.
2025-12-22 23:32:08,931 - __main__ - INFO - Perturbed data found in cache. Loading from disk.
2025-12-22 23:32:08,940 - __main__ - INFO - Perturbations complete.
2025-12-22 23:32:08,940 - __main__ - INFO - 
====================================================================================================
2025-12-22 23:32:08,940 - __main__ - INFO - Running BASELINE (no optimization)...
2025-12-22 23:32:08,943 - __main__ - INFO - Extracting embeddings...
2025-12-22 23:32:10,810 - __main__ - INFO - Extracted embeddings shape: (100, 256)
2025-12-22 23:32:10,810 - __main__ - INFO - Extracting embeddings for perturbations on 5 genes...
2025-12-22 23:32:10,810 - __main__ - INFO - Extraxcting embeddings for perturbed: FAAP20 (type: knockout)
2025-12-22 23:32:10,811 - __main__ - INFO - Extracting embeddings...
2025-12-22 23:32:11,195 - __main__ - INFO - Extracted embeddings shape: (100, 256)
2025-12-22 23:32:11,195 - __main__ - INFO - Extraxcting embeddings for perturbed: SSU72 (type: knockout)
2025-12-22 23:32:11,195 - __main__ - INFO - Extracting embeddings...
2025-12-22 23:32:11,578 - __main__ - INFO - Extracted embeddings shape: (100, 256)
2025-12-22 23:32:11,578 - __main__ - INFO - Extraxcting embeddings for perturbed: MRPL20 (type: knockout)
2025-12-22 23:32:11,578 - __main__ - INFO - Extracting embeddings...
2025-12-22 23:32:11,961 - __main__ - INFO - Extracted embeddings shape: (100, 256)
2025-12-22 23:32:11,961 - __main__ - INFO - Extraxcting embeddings for perturbed: AURKAIP1 (type: knockout)
2025-12-22 23:32:11,961 - __main__ - INFO - Extracting embeddings...
2025-12-22 23:32:12,340 - __main__ - INFO - Extracted embeddings shape: (100, 256)
2025-12-22 23:32:12,340 - __main__ - INFO - Extraxcting embeddings for perturbed: RPL22 (type: knockout)
2025-12-22 23:32:12,340 - __main__ - INFO - Extracting embeddings...
2025-12-22 23:32:12,726 - __main__ - INFO - Extracted embeddings shape: (100, 256)
2025-12-22 23:32:12,726 - __main__ - INFO - Finished getting perturbation results.
2025-12-22 23:32:12,758 - __main__ - INFO - Saved outputs for baseline to outputs/outputs/baseline
2025-12-22 23:32:12,759 - __main__ - INFO - 
====================================================================================================
2025-12-22 23:32:12,759 - __main__ - INFO - Running with DISTRIBUTED optimization...
2025-12-22 23:32:12,760 - __main__ - INFO - Extracting embeddings...
2025-12-22 23:32:13,138 - __main__ - INFO - Extracted embeddings shape: (100, 256)
2025-12-22 23:32:13,138 - __main__ - INFO - Using 4 GPUs with DDP
2025-12-22 23:32:13,180 - __main__ - INFO - Using temporary directory: /scratch/ddp_results_bka182p_
2025-12-22 23:33:19,514 - __main__ - ERROR - distributed failed: 'FAAP20'
Traceback (most recent call last):
  File "/root/capsule/code/helical-challenge/main.py", line 1379, in run
    perf_metrics, outputs = runner(model, data,
  File "/root/capsule/code/helical-challenge/main.py", line 1091, in run_with_distributed_ddp
    perturbation_list_gene.append(results['perturbation_results'][gene])
KeyError: 'FAAP20'
2025-12-22 23:33:19,515 - __main__ - INFO - 
====================================================================================================
2025-12-22 23:33:19,515 - __main__ - INFO - COMPARING OUTPUTS TO BASELINE
2025-12-22 23:33:19,515 - __main__ - INFO - ====================================================================================================
2025-12-22 23:33:19,518 - __main__ - INFO - Performance metrics saved to: outputs/performance_metrics_20251222_233319.csv
2025-12-22 23:33:19,521 - __main__ - INFO - 
====================================================================================================
2025-12-22 23:33:19,521 - __main__ - INFO - PERFORMANCE SUMMARY
2025-12-22 23:33:19,521 - __main__ - INFO - ====================================================================================================
2025-12-22 23:33:19,524 - __main__ - INFO - 
     method  runtime_seconds  cpu_percent    memory_mb  gpu_memory_mb  gpu_utilization  throughput_cells_per_sec  num_cells  num_genes_perturbed                   timestamp extra_optimization
0  baseline         3.785639         87.7  5719.105469      48.404785               19                 26.415623        100                    5  2025-12-22T23:32:12.727871               none

2025-12-22 23:33:19,525 - __main__ - INFO - 
SPEEDUP RELATIVE TO BASELINE:
2025-12-22 23:33:19,525 - __main__ - INFO - --------------------------------------------------
2025-12-22 23:33:19,525 - __main__ - INFO - ====================================================================================================
2025-12-22 23:33:19,525 - __main__ - INFO - 
All outputs saved to: outputs
2025-12-22 23:33:19,525 - __main__ - INFO - 
====================================================================================================
2025-12-22 23:33:19,525 - __main__ - INFO - PIPELINE COMPLETE!
2025-12-22 23:33:19,525 - __main__ - INFO - ====================================================================================================
