[2025-12-17 21:22:38,960][__main__][INFO] - Using device: cuda
[2025-12-17 21:22:38,962][__main__][INFO] - ====================================================================================================
[2025-12-17 21:22:38,962][__main__][INFO] - GENEFORMER PERTURBATION PIPELINE
[2025-12-17 21:22:38,962][__main__][INFO] - ====================================================================================================
[2025-12-17 21:22:38,963][__main__][INFO] - Experiment: geneformer_perturbation
[2025-12-17 21:22:38,968][__main__][INFO] - 
Configuration:
seed: 42
verbose: true
model:
  name: gf-12L-38M-i4096
  batch_size: 32
  max_length: 2048
  device: cuda:0
data:
  pertpy_data_identifier: norman_2019
  condition_filter: control
  gene_names_column: index
  use_raw_counts: false
  preprocess: true
  normalize: true
  filter_genes: true
  min_genes: 200
  min_cells: 3
  max_cells: 1000
  max_genes: 100
perturbation:
  gene_list: null
  num_genes: 10
  perturbation_type: knockout
  selection_method: top_expressed
  perturbation_strength: 2.0
optimization:
  methods:
  - distributed
  batching:
    enabled: true
    batch_size_multiplier: 2
    use_dataloader: true
    num_workers: 4
    pin_memory: true
  quantization:
    enabled: true
    dtype: qint8
    quantize_layers:
    - torch.nn.Linear
    dynamic: true
  onnx:
    enabled: true
    opset_version: 14
    optimize: true
    use_gpu: true
    precision: FP16
  distributed:
    enabled: true
    backend: nccl
    world_size: null
    use_data_parallel: false
output:
  dir: outputs
  save_outputs: true
  compression: null
  precision: float32
  save_embeddings: true
  save_perturbations: true
  save_metadata: true
  save_cell_ids: true
  save_gene_names: true
  save_detailed_comparisons: true
  log_level: INFO
  log_to_file: true
  log_file: pipeline.log
hardware:
  device: auto
  mixed_precision: false
  cudnn_benchmark: true
  empty_cache_between_methods: true
  max_memory_gb: null
experiment:
  name: geneformer_perturbation
  tags: []
  notes: ''
reproducibility:
  deterministic: true
  benchmark: false
advanced:
  gradient_checkpointing: false
  compile_model: false
  compile_backend: inductor
  continue_on_error: true
  max_retries: 3
validation:
  min_correlation: 0.95
  max_mse: 0.01
  warn_on_threshold: true
  check_nan: true
  check_inf: true

[2025-12-17 21:22:38,968][__main__][INFO] - Loading Geneformer model...
[2025-12-17 21:22:44,260][helical.models.geneformer.model][INFO] - Model finished initializing.
[2025-12-17 21:22:44,260][helical.models.geneformer.model][INFO] - 'gf-12L-38M-i4096' model is in 'eval' mode, on device 'cuda:0' with embedding mode 'cell'.
[2025-12-17 21:22:44,262][__main__][INFO] - Model loaded: gf-12L-38M-i4096
[2025-12-17 21:22:44,262][__main__][INFO] - Loading data: norman_2019
[2025-12-17 21:23:10,980][__main__][INFO] - Loaded 11835 cells, 19018 genes
[2025-12-17 21:23:10,980][__main__][INFO] - Preprocessing data...
[2025-12-17 21:23:11,420][py.warnings][WARNING] - /opt/conda/lib/python3.10/site-packages/scanpy/preprocessing/_simple.py:176: ImplicitModificationWarning: Trying to modify attribute `.obs` of view, initializing view as actual.
  adata.obs["n_genes"] = number

[2025-12-17 21:23:13,504][__main__][INFO] - After filtering: 11835 cells, 18215 genes
[2025-12-17 21:23:13,665][__main__][INFO] - Data normalized
[2025-12-17 21:23:13,670][__main__][INFO] - Subsetted to 1000 cells for testing
[2025-12-17 21:23:13,672][__main__][INFO] - Subsetted to 100 genes for testing
[2025-12-17 21:23:13,672][__main__][INFO] - Tokenizing data...
[2025-12-17 21:23:13,673][helical.models.geneformer.model][INFO] - Processing data for Geneformer.
[2025-12-17 21:23:13,673][py.warnings][WARNING] - /opt/conda/lib/python3.10/site-packages/helical/models/base_models.py:88: ImplicitModificationWarning: Trying to modify attribute `.var` of view, initializing view as actual.
  adata.var["index"] = adata.var.index

[2025-12-17 21:23:14,029][helical.utils.mapping][INFO] - Mapped 68 / 100 genes to Ensembl IDs.
[2025-12-17 21:23:14,046][helical.models.geneformer.geneformer_tokenizer][INFO] - AnnData object with n_obs × n_vars = 1000 × 100
    obs: 'guide_identity', 'read_count', 'UMI_count', 'coverage', 'gemgroup', 'good_coverage', 'number_of_cells', 'guide_AHR', 'guide_ARID1A', 'guide_ARRDC3', 'guide_ATL1', 'guide_BAK1', 'guide_BCL2L11', 'guide_BCORL1', 'guide_BPGM', 'guide_C19orf26', 'guide_C3orf72', 'guide_CBFA2T3', 'guide_CBL', 'guide_CDKN1A', 'guide_CDKN1B', 'guide_CDKN1C', 'guide_CEBPA', 'guide_CEBPB', 'guide_CEBPE', 'guide_CELF2', 'guide_CITED1', 'guide_CKS1B', 'guide_CLDN6', 'guide_CNN1', 'guide_CNNM4', 'guide_COL1A1', 'guide_COL2A1', 'guide_CSRNP1', 'guide_DLX2', 'guide_DUSP9', 'guide_EGR1', 'guide_ELMSAN1', 'guide_ETS2', 'guide_FEV', 'guide_FOSB', 'guide_FOXA1', 'guide_FOXA3', 'guide_FOXF1', 'guide_FOXL2', 'guide_FOXO4', 'guide_GLB1L2', 'guide_HES7', 'guide_HK2', 'guide_HNF4A', 'guide_HOXA13', 'guide_HOXB9', 'guide_HOXC13', 'guide_IER5L', 'guide_IGDCC3', 'guide_IKZF3', 'guide_IRF1', 'guide_ISL2', 'guide_JUN', 'guide_KIAA1804', 'guide_KIF18B', 'guide_KIF2C', 'guide_KLF1', 'guide_KMT2A', 'guide_LHX1', 'guide_LYL1', 'guide_MAML2', 'guide_MAP2K3', 'guide_MAP2K6', 'guide_MAP4K3', 'guide_MAP4K5', 'guide_MAP7D1', 'guide_MAPK1', 'guide_MEIS1', 'guide_MIDN', 'guide_NCL', 'guide_NIT1', 'guide_OSR2', 'guide_PLK4', 'guide_POU3F2', 'guide_PRDM1', 'guide_PRTG', 'guide_PTPN1', 'guide_PTPN12', 'guide_PTPN13', 'guide_PTPN9', 'guide_RHOXF2', 'guide_RREB1', 'guide_RUNX1T1', 'guide_S1PR2', 'guide_SAMD1', 'guide_SET', 'guide_SGK1', 'guide_SLC38A2', 'guide_SLC4A1', 'guide_SLC6A9', 'guide_SNAI1', 'guide_SPI1', 'guide_STIL', 'guide_TBX2', 'guide_TBX3', 'guide_TGFBR2', 'guide_TMSB4X', 'guide_TP73', 'guide_TSC22D1', 'guide_UBASH3A', 'guide_UBASH3B', 'guide_ZBTB1', 'guide_ZBTB10', 'guide_ZBTB25', 'guide_ZC3HAV1', 'guide_ZNF318', 'guide_ids', 'n_genes', 'n_genes_by_counts', 'total_counts', 'total_counts_mt', 'pct_counts_mt', 'leiden', 'perturbation_name', 'perturbation_type', 'perturbation_value', 'perturbation_unit'
    var: 'index', 'n_cells', 'mt', 'n_cells_by_counts', 'mean_counts', 'pct_dropout_by_counts', 'total_counts', 'highly_variable', 'means', 'dispersions', 'dispersions_norm', 'ensembl_id', 'ensembl_id_collapsed'
    uns: 'doi', 'hvg', 'leiden', 'neighbors', 'pca', 'preprocessing_nb_link', 'umap', 'log1p'
    obsm: 'X_pca', 'X_umap'
    varm: 'PCs'
    layers: 'counts'
    obsp: 'connectivities', 'distances' has no column attribute 'filter_pass'; tokenizing all cells.
[2025-12-17 21:23:14,177][helical.models.geneformer.geneformer_tokenizer][INFO] - Creating dataset.
[2025-12-17 21:23:14,198][helical.models.geneformer.model][INFO] - Successfully processed the data for Geneformer.
[2025-12-17 21:23:14,198][__main__][INFO] - Tokenization complete
[2025-12-17 21:23:14,199][__main__][INFO] - Selected 10 genes using method: top_expressed
[2025-12-17 21:23:14,199][__main__][INFO] - 
====================================================================================================
[2025-12-17 21:23:14,199][__main__][INFO] - Running BASELINE (no optimization)...
[2025-12-17 21:23:14,202][__main__][INFO] - Extracting embeddings...
[2025-12-17 21:23:14,202][__main__][ERROR] - Baseline failed: 'Dataset' object has no attribute 'get_embeddings'
Traceback (most recent call last):
  File "/root/capsule/code/helical-challenge/main.py", line 1085, in run
    perf_metrics, outputs = self.run_baseline(model, data, adata, genes)
  File "/root/capsule/code/helical-challenge/main.py", line 566, in run_baseline
    embeddings = self.extract_embeddings(model, data)
  File "/root/capsule/code/helical-challenge/main.py", line 505, in extract_embeddings
    embeddings = model.get_embeddings(data)
AttributeError: 'Dataset' object has no attribute 'get_embeddings'
[2025-12-17 21:23:14,207][__main__][INFO] - 
====================================================================================================
[2025-12-17 21:23:14,207][__main__][INFO] - Running with DISTRIBUTED optimization...
[2025-12-17 21:23:14,207][__main__][WARNING] - Only 1 GPU available, distributed mode may not provide benefits
[2025-12-17 21:23:14,208][__main__][ERROR] - distributed failed: name 'world_size' is not defined
Traceback (most recent call last):
  File "/root/capsule/code/helical-challenge/main.py", line 1135, in run
    perf_metrics, outputs = runner(model, data, adata, genes)
  File "/root/capsule/code/helical-challenge/main.py", line 861, in run_with_distributed
    nprocs=world_size, join=True)
NameError: name 'world_size' is not defined
[2025-12-17 21:23:14,211][__main__][INFO] - 
====================================================================================================
[2025-12-17 21:23:14,211][__main__][INFO] - COMPARING OUTPUTS TO BASELINE
[2025-12-17 21:23:14,211][__main__][INFO] - ====================================================================================================
[2025-12-17 21:23:14,211][__main__][ERROR] - No methods completed successfully
