[2025-12-17 21:32:12,740][__main__][INFO] - Using device: cuda
[2025-12-17 21:32:12,743][__main__][INFO] - ====================================================================================================
[2025-12-17 21:32:12,743][__main__][INFO] - GENEFORMER PERTURBATION PIPELINE
[2025-12-17 21:32:12,743][__main__][INFO] - ====================================================================================================
[2025-12-17 21:32:12,743][__main__][INFO] - Experiment: geneformer_perturbation
[2025-12-17 21:32:12,748][__main__][INFO] - 
Configuration:
seed: 42
verbose: true
model:
  name: gf-12L-38M-i4096
  batch_size: 32
  max_length: 2048
  device: cuda:0
data:
  pertpy_data_identifier: norman_2019
  condition_filter: control
  gene_names_column: index
  use_raw_counts: false
  preprocess: true
  normalize: true
  filter_genes: true
  min_genes: 200
  min_cells: 3
  max_cells: 1000
  max_genes: 100
perturbation:
  gene_list: null
  num_genes: 10
  perturbation_type: knockout
  selection_method: top_expressed
  perturbation_strength: 2.0
optimization:
  methods:
  - distributed
  batching:
    enabled: true
    batch_size_multiplier: 2
    use_dataloader: true
    num_workers: 4
    pin_memory: true
  quantization:
    enabled: true
    dtype: qint8
    quantize_layers:
    - torch.nn.Linear
    dynamic: true
  onnx:
    enabled: true
    opset_version: 14
    optimize: true
    use_gpu: true
    precision: FP16
  distributed:
    enabled: true
    backend: nccl
    world_size: null
    use_data_parallel: true
output:
  dir: outputs
  save_outputs: true
  compression: null
  precision: float32
  save_embeddings: true
  save_perturbations: true
  save_metadata: true
  save_cell_ids: true
  save_gene_names: true
  save_detailed_comparisons: true
  log_level: INFO
  log_to_file: true
  log_file: pipeline.log
hardware:
  device: auto
  mixed_precision: false
  cudnn_benchmark: true
  empty_cache_between_methods: true
  max_memory_gb: null
experiment:
  name: geneformer_perturbation
  tags: []
  notes: ''
reproducibility:
  deterministic: true
  benchmark: false
advanced:
  gradient_checkpointing: false
  compile_model: false
  compile_backend: inductor
  continue_on_error: true
  max_retries: 3
validation:
  min_correlation: 0.95
  max_mse: 0.01
  warn_on_threshold: true
  check_nan: true
  check_inf: true

[2025-12-17 21:32:12,748][__main__][INFO] - Loading Geneformer model...
[2025-12-17 21:32:17,985][helical.models.geneformer.model][INFO] - Model finished initializing.
[2025-12-17 21:32:17,986][helical.models.geneformer.model][INFO] - 'gf-12L-38M-i4096' model is in 'eval' mode, on device 'cuda:0' with embedding mode 'cell'.
[2025-12-17 21:32:17,987][__main__][INFO] - Model loaded: gf-12L-38M-i4096
[2025-12-17 21:32:17,987][__main__][INFO] - Loading data: norman_2019
[2025-12-17 21:32:44,629][__main__][INFO] - Loaded 11835 cells, 19018 genes
[2025-12-17 21:32:44,629][__main__][INFO] - Preprocessing data...
[2025-12-17 21:32:45,069][py.warnings][WARNING] - /opt/conda/lib/python3.10/site-packages/scanpy/preprocessing/_simple.py:176: ImplicitModificationWarning: Trying to modify attribute `.obs` of view, initializing view as actual.
  adata.obs["n_genes"] = number

[2025-12-17 21:32:47,155][__main__][INFO] - After filtering: 11835 cells, 18215 genes
[2025-12-17 21:32:47,313][__main__][INFO] - Data normalized
[2025-12-17 21:32:47,318][__main__][INFO] - Subsetted to 1000 cells for testing
[2025-12-17 21:32:47,321][__main__][INFO] - Subsetted to 100 genes for testing
[2025-12-17 21:32:47,321][__main__][INFO] - Tokenizing data...
[2025-12-17 21:32:47,321][helical.models.geneformer.model][INFO] - Processing data for Geneformer.
[2025-12-17 21:32:47,321][py.warnings][WARNING] - /opt/conda/lib/python3.10/site-packages/helical/models/base_models.py:88: ImplicitModificationWarning: Trying to modify attribute `.var` of view, initializing view as actual.
  adata.var["index"] = adata.var.index

[2025-12-17 21:32:47,674][helical.utils.mapping][INFO] - Mapped 68 / 100 genes to Ensembl IDs.
[2025-12-17 21:32:47,692][helical.models.geneformer.geneformer_tokenizer][INFO] - AnnData object with n_obs × n_vars = 1000 × 100
    obs: 'guide_identity', 'read_count', 'UMI_count', 'coverage', 'gemgroup', 'good_coverage', 'number_of_cells', 'guide_AHR', 'guide_ARID1A', 'guide_ARRDC3', 'guide_ATL1', 'guide_BAK1', 'guide_BCL2L11', 'guide_BCORL1', 'guide_BPGM', 'guide_C19orf26', 'guide_C3orf72', 'guide_CBFA2T3', 'guide_CBL', 'guide_CDKN1A', 'guide_CDKN1B', 'guide_CDKN1C', 'guide_CEBPA', 'guide_CEBPB', 'guide_CEBPE', 'guide_CELF2', 'guide_CITED1', 'guide_CKS1B', 'guide_CLDN6', 'guide_CNN1', 'guide_CNNM4', 'guide_COL1A1', 'guide_COL2A1', 'guide_CSRNP1', 'guide_DLX2', 'guide_DUSP9', 'guide_EGR1', 'guide_ELMSAN1', 'guide_ETS2', 'guide_FEV', 'guide_FOSB', 'guide_FOXA1', 'guide_FOXA3', 'guide_FOXF1', 'guide_FOXL2', 'guide_FOXO4', 'guide_GLB1L2', 'guide_HES7', 'guide_HK2', 'guide_HNF4A', 'guide_HOXA13', 'guide_HOXB9', 'guide_HOXC13', 'guide_IER5L', 'guide_IGDCC3', 'guide_IKZF3', 'guide_IRF1', 'guide_ISL2', 'guide_JUN', 'guide_KIAA1804', 'guide_KIF18B', 'guide_KIF2C', 'guide_KLF1', 'guide_KMT2A', 'guide_LHX1', 'guide_LYL1', 'guide_MAML2', 'guide_MAP2K3', 'guide_MAP2K6', 'guide_MAP4K3', 'guide_MAP4K5', 'guide_MAP7D1', 'guide_MAPK1', 'guide_MEIS1', 'guide_MIDN', 'guide_NCL', 'guide_NIT1', 'guide_OSR2', 'guide_PLK4', 'guide_POU3F2', 'guide_PRDM1', 'guide_PRTG', 'guide_PTPN1', 'guide_PTPN12', 'guide_PTPN13', 'guide_PTPN9', 'guide_RHOXF2', 'guide_RREB1', 'guide_RUNX1T1', 'guide_S1PR2', 'guide_SAMD1', 'guide_SET', 'guide_SGK1', 'guide_SLC38A2', 'guide_SLC4A1', 'guide_SLC6A9', 'guide_SNAI1', 'guide_SPI1', 'guide_STIL', 'guide_TBX2', 'guide_TBX3', 'guide_TGFBR2', 'guide_TMSB4X', 'guide_TP73', 'guide_TSC22D1', 'guide_UBASH3A', 'guide_UBASH3B', 'guide_ZBTB1', 'guide_ZBTB10', 'guide_ZBTB25', 'guide_ZC3HAV1', 'guide_ZNF318', 'guide_ids', 'n_genes', 'n_genes_by_counts', 'total_counts', 'total_counts_mt', 'pct_counts_mt', 'leiden', 'perturbation_name', 'perturbation_type', 'perturbation_value', 'perturbation_unit'
    var: 'index', 'n_cells', 'mt', 'n_cells_by_counts', 'mean_counts', 'pct_dropout_by_counts', 'total_counts', 'highly_variable', 'means', 'dispersions', 'dispersions_norm', 'ensembl_id', 'ensembl_id_collapsed'
    uns: 'doi', 'hvg', 'leiden', 'neighbors', 'pca', 'preprocessing_nb_link', 'umap', 'log1p'
    obsm: 'X_pca', 'X_umap'
    varm: 'PCs'
    layers: 'counts'
    obsp: 'connectivities', 'distances' has no column attribute 'filter_pass'; tokenizing all cells.
[2025-12-17 21:32:47,821][helical.models.geneformer.geneformer_tokenizer][INFO] - Creating dataset.
[2025-12-17 21:32:47,842][helical.models.geneformer.model][INFO] - Successfully processed the data for Geneformer.
[2025-12-17 21:32:47,842][__main__][INFO] - Tokenization complete
[2025-12-17 21:32:47,843][__main__][INFO] - Selected 10 genes using method: top_expressed
[2025-12-17 21:32:47,843][__main__][INFO] - 
====================================================================================================
[2025-12-17 21:32:47,843][__main__][INFO] - Running BASELINE (no optimization)...
[2025-12-17 21:32:47,846][__main__][INFO] - Extracting embeddings...
[2025-12-17 21:32:47,846][helical.models.geneformer.model][INFO] - Started getting embeddings:
[2025-12-17 21:32:47,846][helical.models.geneformer.geneformer_utils][WARNING] - CLS token present in token dictionary, excluding from average.
[2025-12-17 21:32:47,846][helical.models.geneformer.geneformer_utils][WARNING] - EOS token present in token dictionary, excluding from average.
[2025-12-17 21:32:49,477][helical.models.geneformer.model][INFO] - Finished getting embeddings.
[2025-12-17 21:32:49,477][__main__][INFO] - Extracted embeddings shape: (1000, 512)
[2025-12-17 21:32:49,477][__main__][INFO] - Performing perturbation on 10 genes...
[2025-12-17 21:32:49,477][__main__][INFO] - Perturbing gene: UBE2J2 (type: knockout)
[2025-12-17 21:32:49,478][__main__][WARNING] - Using manual perturbation for UBE2J2
[2025-12-17 21:32:49,480][py.warnings][WARNING] - /opt/conda/lib/python3.10/site-packages/scipy/sparse/_index.py:151: SparseEfficiencyWarning: Changing the sparsity structure of a csr_matrix is expensive. lil_matrix is more efficient.
  self._set_arrayXarray(i, j, x)

[2025-12-17 21:32:49,485][helical.models.geneformer.model][INFO] - Processing data for Geneformer.
[2025-12-17 21:32:49,833][helical.utils.mapping][INFO] - Mapped 68 / 100 genes to Ensembl IDs.
[2025-12-17 21:32:49,850][helical.models.geneformer.geneformer_tokenizer][INFO] - AnnData object with n_obs × n_vars = 1000 × 100
    obs: 'guide_identity', 'read_count', 'UMI_count', 'coverage', 'gemgroup', 'good_coverage', 'number_of_cells', 'guide_AHR', 'guide_ARID1A', 'guide_ARRDC3', 'guide_ATL1', 'guide_BAK1', 'guide_BCL2L11', 'guide_BCORL1', 'guide_BPGM', 'guide_C19orf26', 'guide_C3orf72', 'guide_CBFA2T3', 'guide_CBL', 'guide_CDKN1A', 'guide_CDKN1B', 'guide_CDKN1C', 'guide_CEBPA', 'guide_CEBPB', 'guide_CEBPE', 'guide_CELF2', 'guide_CITED1', 'guide_CKS1B', 'guide_CLDN6', 'guide_CNN1', 'guide_CNNM4', 'guide_COL1A1', 'guide_COL2A1', 'guide_CSRNP1', 'guide_DLX2', 'guide_DUSP9', 'guide_EGR1', 'guide_ELMSAN1', 'guide_ETS2', 'guide_FEV', 'guide_FOSB', 'guide_FOXA1', 'guide_FOXA3', 'guide_FOXF1', 'guide_FOXL2', 'guide_FOXO4', 'guide_GLB1L2', 'guide_HES7', 'guide_HK2', 'guide_HNF4A', 'guide_HOXA13', 'guide_HOXB9', 'guide_HOXC13', 'guide_IER5L', 'guide_IGDCC3', 'guide_IKZF3', 'guide_IRF1', 'guide_ISL2', 'guide_JUN', 'guide_KIAA1804', 'guide_KIF18B', 'guide_KIF2C', 'guide_KLF1', 'guide_KMT2A', 'guide_LHX1', 'guide_LYL1', 'guide_MAML2', 'guide_MAP2K3', 'guide_MAP2K6', 'guide_MAP4K3', 'guide_MAP4K5', 'guide_MAP7D1', 'guide_MAPK1', 'guide_MEIS1', 'guide_MIDN', 'guide_NCL', 'guide_NIT1', 'guide_OSR2', 'guide_PLK4', 'guide_POU3F2', 'guide_PRDM1', 'guide_PRTG', 'guide_PTPN1', 'guide_PTPN12', 'guide_PTPN13', 'guide_PTPN9', 'guide_RHOXF2', 'guide_RREB1', 'guide_RUNX1T1', 'guide_S1PR2', 'guide_SAMD1', 'guide_SET', 'guide_SGK1', 'guide_SLC38A2', 'guide_SLC4A1', 'guide_SLC6A9', 'guide_SNAI1', 'guide_SPI1', 'guide_STIL', 'guide_TBX2', 'guide_TBX3', 'guide_TGFBR2', 'guide_TMSB4X', 'guide_TP73', 'guide_TSC22D1', 'guide_UBASH3A', 'guide_UBASH3B', 'guide_ZBTB1', 'guide_ZBTB10', 'guide_ZBTB25', 'guide_ZC3HAV1', 'guide_ZNF318', 'guide_ids', 'n_genes', 'n_genes_by_counts', 'total_counts', 'total_counts_mt', 'pct_counts_mt', 'leiden', 'perturbation_name', 'perturbation_type', 'perturbation_value', 'perturbation_unit'
    var: 'index', 'n_cells', 'mt', 'n_cells_by_counts', 'mean_counts', 'pct_dropout_by_counts', 'total_counts', 'highly_variable', 'means', 'dispersions', 'dispersions_norm', 'ensembl_id', 'ensembl_id_collapsed'
    uns: 'doi', 'hvg', 'leiden', 'neighbors', 'pca', 'preprocessing_nb_link', 'umap', 'log1p'
    obsm: 'X_pca', 'X_umap'
    varm: 'PCs'
    layers: 'counts'
    obsp: 'connectivities', 'distances' has no column attribute 'filter_pass'; tokenizing all cells.
[2025-12-17 21:32:49,977][helical.models.geneformer.geneformer_tokenizer][INFO] - Creating dataset.
[2025-12-17 21:32:49,995][helical.models.geneformer.model][INFO] - Successfully processed the data for Geneformer.
[2025-12-17 21:32:49,995][__main__][INFO] - Extracting embeddings...
[2025-12-17 21:32:49,995][helical.models.geneformer.model][INFO] - Started getting embeddings:
[2025-12-17 21:32:49,995][helical.models.geneformer.geneformer_utils][WARNING] - CLS token present in token dictionary, excluding from average.
[2025-12-17 21:32:49,995][helical.models.geneformer.geneformer_utils][WARNING] - EOS token present in token dictionary, excluding from average.
[2025-12-17 21:32:50,566][helical.models.geneformer.model][INFO] - Finished getting embeddings.
[2025-12-17 21:32:50,566][__main__][INFO] - Extracted embeddings shape: (1000, 512)
[2025-12-17 21:32:50,567][__main__][INFO] - Perturbing gene: SDF4 (type: knockout)
[2025-12-17 21:32:50,567][__main__][WARNING] - Using manual perturbation for SDF4
[2025-12-17 21:32:50,569][py.warnings][WARNING] - /opt/conda/lib/python3.10/site-packages/scipy/sparse/_index.py:151: SparseEfficiencyWarning: Changing the sparsity structure of a csr_matrix is expensive. lil_matrix is more efficient.
  self._set_arrayXarray(i, j, x)

[2025-12-17 21:32:50,573][helical.models.geneformer.model][INFO] - Processing data for Geneformer.
[2025-12-17 21:32:50,918][helical.utils.mapping][INFO] - Mapped 68 / 100 genes to Ensembl IDs.
[2025-12-17 21:32:50,935][helical.models.geneformer.geneformer_tokenizer][INFO] - AnnData object with n_obs × n_vars = 1000 × 100
    obs: 'guide_identity', 'read_count', 'UMI_count', 'coverage', 'gemgroup', 'good_coverage', 'number_of_cells', 'guide_AHR', 'guide_ARID1A', 'guide_ARRDC3', 'guide_ATL1', 'guide_BAK1', 'guide_BCL2L11', 'guide_BCORL1', 'guide_BPGM', 'guide_C19orf26', 'guide_C3orf72', 'guide_CBFA2T3', 'guide_CBL', 'guide_CDKN1A', 'guide_CDKN1B', 'guide_CDKN1C', 'guide_CEBPA', 'guide_CEBPB', 'guide_CEBPE', 'guide_CELF2', 'guide_CITED1', 'guide_CKS1B', 'guide_CLDN6', 'guide_CNN1', 'guide_CNNM4', 'guide_COL1A1', 'guide_COL2A1', 'guide_CSRNP1', 'guide_DLX2', 'guide_DUSP9', 'guide_EGR1', 'guide_ELMSAN1', 'guide_ETS2', 'guide_FEV', 'guide_FOSB', 'guide_FOXA1', 'guide_FOXA3', 'guide_FOXF1', 'guide_FOXL2', 'guide_FOXO4', 'guide_GLB1L2', 'guide_HES7', 'guide_HK2', 'guide_HNF4A', 'guide_HOXA13', 'guide_HOXB9', 'guide_HOXC13', 'guide_IER5L', 'guide_IGDCC3', 'guide_IKZF3', 'guide_IRF1', 'guide_ISL2', 'guide_JUN', 'guide_KIAA1804', 'guide_KIF18B', 'guide_KIF2C', 'guide_KLF1', 'guide_KMT2A', 'guide_LHX1', 'guide_LYL1', 'guide_MAML2', 'guide_MAP2K3', 'guide_MAP2K6', 'guide_MAP4K3', 'guide_MAP4K5', 'guide_MAP7D1', 'guide_MAPK1', 'guide_MEIS1', 'guide_MIDN', 'guide_NCL', 'guide_NIT1', 'guide_OSR2', 'guide_PLK4', 'guide_POU3F2', 'guide_PRDM1', 'guide_PRTG', 'guide_PTPN1', 'guide_PTPN12', 'guide_PTPN13', 'guide_PTPN9', 'guide_RHOXF2', 'guide_RREB1', 'guide_RUNX1T1', 'guide_S1PR2', 'guide_SAMD1', 'guide_SET', 'guide_SGK1', 'guide_SLC38A2', 'guide_SLC4A1', 'guide_SLC6A9', 'guide_SNAI1', 'guide_SPI1', 'guide_STIL', 'guide_TBX2', 'guide_TBX3', 'guide_TGFBR2', 'guide_TMSB4X', 'guide_TP73', 'guide_TSC22D1', 'guide_UBASH3A', 'guide_UBASH3B', 'guide_ZBTB1', 'guide_ZBTB10', 'guide_ZBTB25', 'guide_ZC3HAV1', 'guide_ZNF318', 'guide_ids', 'n_genes', 'n_genes_by_counts', 'total_counts', 'total_counts_mt', 'pct_counts_mt', 'leiden', 'perturbation_name', 'perturbation_type', 'perturbation_value', 'perturbation_unit'
    var: 'index', 'n_cells', 'mt', 'n_cells_by_counts', 'mean_counts', 'pct_dropout_by_counts', 'total_counts', 'highly_variable', 'means', 'dispersions', 'dispersions_norm', 'ensembl_id', 'ensembl_id_collapsed'
    uns: 'doi', 'hvg', 'leiden', 'neighbors', 'pca', 'preprocessing_nb_link', 'umap', 'log1p'
    obsm: 'X_pca', 'X_umap'
    varm: 'PCs'
    layers: 'counts'
    obsp: 'connectivities', 'distances' has no column attribute 'filter_pass'; tokenizing all cells.
[2025-12-17 21:32:51,064][helical.models.geneformer.geneformer_tokenizer][INFO] - Creating dataset.
[2025-12-17 21:32:51,082][helical.models.geneformer.model][INFO] - Successfully processed the data for Geneformer.
[2025-12-17 21:32:51,082][__main__][INFO] - Extracting embeddings...
[2025-12-17 21:32:51,082][helical.models.geneformer.model][INFO] - Started getting embeddings:
[2025-12-17 21:32:51,082][helical.models.geneformer.geneformer_utils][WARNING] - CLS token present in token dictionary, excluding from average.
[2025-12-17 21:32:51,082][helical.models.geneformer.geneformer_utils][WARNING] - EOS token present in token dictionary, excluding from average.
[2025-12-17 21:32:51,652][helical.models.geneformer.model][INFO] - Finished getting embeddings.
[2025-12-17 21:32:51,653][__main__][INFO] - Extracted embeddings shape: (1000, 512)
[2025-12-17 21:32:51,653][__main__][INFO] - Perturbing gene: RER1 (type: knockout)
[2025-12-17 21:32:51,653][__main__][WARNING] - Using manual perturbation for RER1
[2025-12-17 21:32:51,655][py.warnings][WARNING] - /opt/conda/lib/python3.10/site-packages/scipy/sparse/_index.py:151: SparseEfficiencyWarning: Changing the sparsity structure of a csr_matrix is expensive. lil_matrix is more efficient.
  self._set_arrayXarray(i, j, x)

[2025-12-17 21:32:51,658][helical.models.geneformer.model][INFO] - Processing data for Geneformer.
[2025-12-17 21:32:52,005][helical.utils.mapping][INFO] - Mapped 68 / 100 genes to Ensembl IDs.
[2025-12-17 21:32:52,023][helical.models.geneformer.geneformer_tokenizer][INFO] - AnnData object with n_obs × n_vars = 1000 × 100
    obs: 'guide_identity', 'read_count', 'UMI_count', 'coverage', 'gemgroup', 'good_coverage', 'number_of_cells', 'guide_AHR', 'guide_ARID1A', 'guide_ARRDC3', 'guide_ATL1', 'guide_BAK1', 'guide_BCL2L11', 'guide_BCORL1', 'guide_BPGM', 'guide_C19orf26', 'guide_C3orf72', 'guide_CBFA2T3', 'guide_CBL', 'guide_CDKN1A', 'guide_CDKN1B', 'guide_CDKN1C', 'guide_CEBPA', 'guide_CEBPB', 'guide_CEBPE', 'guide_CELF2', 'guide_CITED1', 'guide_CKS1B', 'guide_CLDN6', 'guide_CNN1', 'guide_CNNM4', 'guide_COL1A1', 'guide_COL2A1', 'guide_CSRNP1', 'guide_DLX2', 'guide_DUSP9', 'guide_EGR1', 'guide_ELMSAN1', 'guide_ETS2', 'guide_FEV', 'guide_FOSB', 'guide_FOXA1', 'guide_FOXA3', 'guide_FOXF1', 'guide_FOXL2', 'guide_FOXO4', 'guide_GLB1L2', 'guide_HES7', 'guide_HK2', 'guide_HNF4A', 'guide_HOXA13', 'guide_HOXB9', 'guide_HOXC13', 'guide_IER5L', 'guide_IGDCC3', 'guide_IKZF3', 'guide_IRF1', 'guide_ISL2', 'guide_JUN', 'guide_KIAA1804', 'guide_KIF18B', 'guide_KIF2C', 'guide_KLF1', 'guide_KMT2A', 'guide_LHX1', 'guide_LYL1', 'guide_MAML2', 'guide_MAP2K3', 'guide_MAP2K6', 'guide_MAP4K3', 'guide_MAP4K5', 'guide_MAP7D1', 'guide_MAPK1', 'guide_MEIS1', 'guide_MIDN', 'guide_NCL', 'guide_NIT1', 'guide_OSR2', 'guide_PLK4', 'guide_POU3F2', 'guide_PRDM1', 'guide_PRTG', 'guide_PTPN1', 'guide_PTPN12', 'guide_PTPN13', 'guide_PTPN9', 'guide_RHOXF2', 'guide_RREB1', 'guide_RUNX1T1', 'guide_S1PR2', 'guide_SAMD1', 'guide_SET', 'guide_SGK1', 'guide_SLC38A2', 'guide_SLC4A1', 'guide_SLC6A9', 'guide_SNAI1', 'guide_SPI1', 'guide_STIL', 'guide_TBX2', 'guide_TBX3', 'guide_TGFBR2', 'guide_TMSB4X', 'guide_TP73', 'guide_TSC22D1', 'guide_UBASH3A', 'guide_UBASH3B', 'guide_ZBTB1', 'guide_ZBTB10', 'guide_ZBTB25', 'guide_ZC3HAV1', 'guide_ZNF318', 'guide_ids', 'n_genes', 'n_genes_by_counts', 'total_counts', 'total_counts_mt', 'pct_counts_mt', 'leiden', 'perturbation_name', 'perturbation_type', 'perturbation_value', 'perturbation_unit'
    var: 'index', 'n_cells', 'mt', 'n_cells_by_counts', 'mean_counts', 'pct_dropout_by_counts', 'total_counts', 'highly_variable', 'means', 'dispersions', 'dispersions_norm', 'ensembl_id', 'ensembl_id_collapsed'
    uns: 'doi', 'hvg', 'leiden', 'neighbors', 'pca', 'preprocessing_nb_link', 'umap', 'log1p'
    obsm: 'X_pca', 'X_umap'
    varm: 'PCs'
    layers: 'counts'
    obsp: 'connectivities', 'distances' has no column attribute 'filter_pass'; tokenizing all cells.
[2025-12-17 21:32:52,152][helical.models.geneformer.geneformer_tokenizer][INFO] - Creating dataset.
[2025-12-17 21:32:52,169][helical.models.geneformer.model][INFO] - Successfully processed the data for Geneformer.
[2025-12-17 21:32:52,169][__main__][INFO] - Extracting embeddings...
[2025-12-17 21:32:52,170][helical.models.geneformer.model][INFO] - Started getting embeddings:
[2025-12-17 21:32:52,170][helical.models.geneformer.geneformer_utils][WARNING] - CLS token present in token dictionary, excluding from average.
[2025-12-17 21:32:52,170][helical.models.geneformer.geneformer_utils][WARNING] - EOS token present in token dictionary, excluding from average.
[2025-12-17 21:32:52,733][helical.models.geneformer.model][INFO] - Finished getting embeddings.
[2025-12-17 21:32:52,733][__main__][INFO] - Extracted embeddings shape: (1000, 512)
[2025-12-17 21:32:52,733][__main__][INFO] - Perturbing gene: NOC2L (type: knockout)
[2025-12-17 21:32:52,733][__main__][WARNING] - Using manual perturbation for NOC2L
[2025-12-17 21:32:52,735][py.warnings][WARNING] - /opt/conda/lib/python3.10/site-packages/scipy/sparse/_index.py:151: SparseEfficiencyWarning: Changing the sparsity structure of a csr_matrix is expensive. lil_matrix is more efficient.
  self._set_arrayXarray(i, j, x)

[2025-12-17 21:32:52,738][helical.models.geneformer.model][INFO] - Processing data for Geneformer.
[2025-12-17 21:32:53,087][helical.utils.mapping][INFO] - Mapped 68 / 100 genes to Ensembl IDs.
[2025-12-17 21:32:53,105][helical.models.geneformer.geneformer_tokenizer][INFO] - AnnData object with n_obs × n_vars = 1000 × 100
    obs: 'guide_identity', 'read_count', 'UMI_count', 'coverage', 'gemgroup', 'good_coverage', 'number_of_cells', 'guide_AHR', 'guide_ARID1A', 'guide_ARRDC3', 'guide_ATL1', 'guide_BAK1', 'guide_BCL2L11', 'guide_BCORL1', 'guide_BPGM', 'guide_C19orf26', 'guide_C3orf72', 'guide_CBFA2T3', 'guide_CBL', 'guide_CDKN1A', 'guide_CDKN1B', 'guide_CDKN1C', 'guide_CEBPA', 'guide_CEBPB', 'guide_CEBPE', 'guide_CELF2', 'guide_CITED1', 'guide_CKS1B', 'guide_CLDN6', 'guide_CNN1', 'guide_CNNM4', 'guide_COL1A1', 'guide_COL2A1', 'guide_CSRNP1', 'guide_DLX2', 'guide_DUSP9', 'guide_EGR1', 'guide_ELMSAN1', 'guide_ETS2', 'guide_FEV', 'guide_FOSB', 'guide_FOXA1', 'guide_FOXA3', 'guide_FOXF1', 'guide_FOXL2', 'guide_FOXO4', 'guide_GLB1L2', 'guide_HES7', 'guide_HK2', 'guide_HNF4A', 'guide_HOXA13', 'guide_HOXB9', 'guide_HOXC13', 'guide_IER5L', 'guide_IGDCC3', 'guide_IKZF3', 'guide_IRF1', 'guide_ISL2', 'guide_JUN', 'guide_KIAA1804', 'guide_KIF18B', 'guide_KIF2C', 'guide_KLF1', 'guide_KMT2A', 'guide_LHX1', 'guide_LYL1', 'guide_MAML2', 'guide_MAP2K3', 'guide_MAP2K6', 'guide_MAP4K3', 'guide_MAP4K5', 'guide_MAP7D1', 'guide_MAPK1', 'guide_MEIS1', 'guide_MIDN', 'guide_NCL', 'guide_NIT1', 'guide_OSR2', 'guide_PLK4', 'guide_POU3F2', 'guide_PRDM1', 'guide_PRTG', 'guide_PTPN1', 'guide_PTPN12', 'guide_PTPN13', 'guide_PTPN9', 'guide_RHOXF2', 'guide_RREB1', 'guide_RUNX1T1', 'guide_S1PR2', 'guide_SAMD1', 'guide_SET', 'guide_SGK1', 'guide_SLC38A2', 'guide_SLC4A1', 'guide_SLC6A9', 'guide_SNAI1', 'guide_SPI1', 'guide_STIL', 'guide_TBX2', 'guide_TBX3', 'guide_TGFBR2', 'guide_TMSB4X', 'guide_TP73', 'guide_TSC22D1', 'guide_UBASH3A', 'guide_UBASH3B', 'guide_ZBTB1', 'guide_ZBTB10', 'guide_ZBTB25', 'guide_ZC3HAV1', 'guide_ZNF318', 'guide_ids', 'n_genes', 'n_genes_by_counts', 'total_counts', 'total_counts_mt', 'pct_counts_mt', 'leiden', 'perturbation_name', 'perturbation_type', 'perturbation_value', 'perturbation_unit'
    var: 'index', 'n_cells', 'mt', 'n_cells_by_counts', 'mean_counts', 'pct_dropout_by_counts', 'total_counts', 'highly_variable', 'means', 'dispersions', 'dispersions_norm', 'ensembl_id', 'ensembl_id_collapsed'
    uns: 'doi', 'hvg', 'leiden', 'neighbors', 'pca', 'preprocessing_nb_link', 'umap', 'log1p'
    obsm: 'X_pca', 'X_umap'
    varm: 'PCs'
    layers: 'counts'
    obsp: 'connectivities', 'distances' has no column attribute 'filter_pass'; tokenizing all cells.
[2025-12-17 21:32:53,233][helical.models.geneformer.geneformer_tokenizer][INFO] - Creating dataset.
[2025-12-17 21:32:53,251][helical.models.geneformer.model][INFO] - Successfully processed the data for Geneformer.
[2025-12-17 21:32:53,251][__main__][INFO] - Extracting embeddings...
[2025-12-17 21:32:53,251][helical.models.geneformer.model][INFO] - Started getting embeddings:
[2025-12-17 21:32:53,251][helical.models.geneformer.geneformer_utils][WARNING] - CLS token present in token dictionary, excluding from average.
[2025-12-17 21:32:53,251][helical.models.geneformer.geneformer_utils][WARNING] - EOS token present in token dictionary, excluding from average.
[2025-12-17 21:32:53,830][helical.models.geneformer.model][INFO] - Finished getting embeddings.
[2025-12-17 21:32:53,830][__main__][INFO] - Extracted embeddings shape: (1000, 512)
[2025-12-17 21:32:53,830][__main__][INFO] - Perturbing gene: GNB1 (type: knockout)
[2025-12-17 21:32:53,830][__main__][WARNING] - Using manual perturbation for GNB1
[2025-12-17 21:32:53,833][py.warnings][WARNING] - /opt/conda/lib/python3.10/site-packages/scipy/sparse/_index.py:151: SparseEfficiencyWarning: Changing the sparsity structure of a csr_matrix is expensive. lil_matrix is more efficient.
  self._set_arrayXarray(i, j, x)

[2025-12-17 21:32:53,836][helical.models.geneformer.model][INFO] - Processing data for Geneformer.
[2025-12-17 21:32:54,189][helical.utils.mapping][INFO] - Mapped 68 / 100 genes to Ensembl IDs.
[2025-12-17 21:32:54,207][helical.models.geneformer.geneformer_tokenizer][INFO] - AnnData object with n_obs × n_vars = 1000 × 100
    obs: 'guide_identity', 'read_count', 'UMI_count', 'coverage', 'gemgroup', 'good_coverage', 'number_of_cells', 'guide_AHR', 'guide_ARID1A', 'guide_ARRDC3', 'guide_ATL1', 'guide_BAK1', 'guide_BCL2L11', 'guide_BCORL1', 'guide_BPGM', 'guide_C19orf26', 'guide_C3orf72', 'guide_CBFA2T3', 'guide_CBL', 'guide_CDKN1A', 'guide_CDKN1B', 'guide_CDKN1C', 'guide_CEBPA', 'guide_CEBPB', 'guide_CEBPE', 'guide_CELF2', 'guide_CITED1', 'guide_CKS1B', 'guide_CLDN6', 'guide_CNN1', 'guide_CNNM4', 'guide_COL1A1', 'guide_COL2A1', 'guide_CSRNP1', 'guide_DLX2', 'guide_DUSP9', 'guide_EGR1', 'guide_ELMSAN1', 'guide_ETS2', 'guide_FEV', 'guide_FOSB', 'guide_FOXA1', 'guide_FOXA3', 'guide_FOXF1', 'guide_FOXL2', 'guide_FOXO4', 'guide_GLB1L2', 'guide_HES7', 'guide_HK2', 'guide_HNF4A', 'guide_HOXA13', 'guide_HOXB9', 'guide_HOXC13', 'guide_IER5L', 'guide_IGDCC3', 'guide_IKZF3', 'guide_IRF1', 'guide_ISL2', 'guide_JUN', 'guide_KIAA1804', 'guide_KIF18B', 'guide_KIF2C', 'guide_KLF1', 'guide_KMT2A', 'guide_LHX1', 'guide_LYL1', 'guide_MAML2', 'guide_MAP2K3', 'guide_MAP2K6', 'guide_MAP4K3', 'guide_MAP4K5', 'guide_MAP7D1', 'guide_MAPK1', 'guide_MEIS1', 'guide_MIDN', 'guide_NCL', 'guide_NIT1', 'guide_OSR2', 'guide_PLK4', 'guide_POU3F2', 'guide_PRDM1', 'guide_PRTG', 'guide_PTPN1', 'guide_PTPN12', 'guide_PTPN13', 'guide_PTPN9', 'guide_RHOXF2', 'guide_RREB1', 'guide_RUNX1T1', 'guide_S1PR2', 'guide_SAMD1', 'guide_SET', 'guide_SGK1', 'guide_SLC38A2', 'guide_SLC4A1', 'guide_SLC6A9', 'guide_SNAI1', 'guide_SPI1', 'guide_STIL', 'guide_TBX2', 'guide_TBX3', 'guide_TGFBR2', 'guide_TMSB4X', 'guide_TP73', 'guide_TSC22D1', 'guide_UBASH3A', 'guide_UBASH3B', 'guide_ZBTB1', 'guide_ZBTB10', 'guide_ZBTB25', 'guide_ZC3HAV1', 'guide_ZNF318', 'guide_ids', 'n_genes', 'n_genes_by_counts', 'total_counts', 'total_counts_mt', 'pct_counts_mt', 'leiden', 'perturbation_name', 'perturbation_type', 'perturbation_value', 'perturbation_unit'
    var: 'index', 'n_cells', 'mt', 'n_cells_by_counts', 'mean_counts', 'pct_dropout_by_counts', 'total_counts', 'highly_variable', 'means', 'dispersions', 'dispersions_norm', 'ensembl_id', 'ensembl_id_collapsed'
    uns: 'doi', 'hvg', 'leiden', 'neighbors', 'pca', 'preprocessing_nb_link', 'umap', 'log1p'
    obsm: 'X_pca', 'X_umap'
    varm: 'PCs'
    layers: 'counts'
    obsp: 'connectivities', 'distances' has no column attribute 'filter_pass'; tokenizing all cells.
[2025-12-17 21:32:54,338][helical.models.geneformer.geneformer_tokenizer][INFO] - Creating dataset.
[2025-12-17 21:32:54,355][helical.models.geneformer.model][INFO] - Successfully processed the data for Geneformer.
[2025-12-17 21:32:54,355][__main__][INFO] - Extracting embeddings...
[2025-12-17 21:32:54,355][helical.models.geneformer.model][INFO] - Started getting embeddings:
[2025-12-17 21:32:54,356][helical.models.geneformer.geneformer_utils][WARNING] - CLS token present in token dictionary, excluding from average.
[2025-12-17 21:32:54,356][helical.models.geneformer.geneformer_utils][WARNING] - EOS token present in token dictionary, excluding from average.
[2025-12-17 21:32:54,921][helical.models.geneformer.model][INFO] - Finished getting embeddings.
[2025-12-17 21:32:54,921][__main__][INFO] - Extracted embeddings shape: (1000, 512)
[2025-12-17 21:32:54,921][__main__][INFO] - Perturbing gene: FAAP20 (type: knockout)
[2025-12-17 21:32:54,921][__main__][WARNING] - Using manual perturbation for FAAP20
[2025-12-17 21:32:54,923][py.warnings][WARNING] - /opt/conda/lib/python3.10/site-packages/scipy/sparse/_index.py:151: SparseEfficiencyWarning: Changing the sparsity structure of a csr_matrix is expensive. lil_matrix is more efficient.
  self._set_arrayXarray(i, j, x)

[2025-12-17 21:32:54,925][helical.models.geneformer.model][INFO] - Processing data for Geneformer.
[2025-12-17 21:32:55,279][helical.utils.mapping][INFO] - Mapped 68 / 100 genes to Ensembl IDs.
[2025-12-17 21:32:55,296][helical.models.geneformer.geneformer_tokenizer][INFO] - AnnData object with n_obs × n_vars = 1000 × 100
    obs: 'guide_identity', 'read_count', 'UMI_count', 'coverage', 'gemgroup', 'good_coverage', 'number_of_cells', 'guide_AHR', 'guide_ARID1A', 'guide_ARRDC3', 'guide_ATL1', 'guide_BAK1', 'guide_BCL2L11', 'guide_BCORL1', 'guide_BPGM', 'guide_C19orf26', 'guide_C3orf72', 'guide_CBFA2T3', 'guide_CBL', 'guide_CDKN1A', 'guide_CDKN1B', 'guide_CDKN1C', 'guide_CEBPA', 'guide_CEBPB', 'guide_CEBPE', 'guide_CELF2', 'guide_CITED1', 'guide_CKS1B', 'guide_CLDN6', 'guide_CNN1', 'guide_CNNM4', 'guide_COL1A1', 'guide_COL2A1', 'guide_CSRNP1', 'guide_DLX2', 'guide_DUSP9', 'guide_EGR1', 'guide_ELMSAN1', 'guide_ETS2', 'guide_FEV', 'guide_FOSB', 'guide_FOXA1', 'guide_FOXA3', 'guide_FOXF1', 'guide_FOXL2', 'guide_FOXO4', 'guide_GLB1L2', 'guide_HES7', 'guide_HK2', 'guide_HNF4A', 'guide_HOXA13', 'guide_HOXB9', 'guide_HOXC13', 'guide_IER5L', 'guide_IGDCC3', 'guide_IKZF3', 'guide_IRF1', 'guide_ISL2', 'guide_JUN', 'guide_KIAA1804', 'guide_KIF18B', 'guide_KIF2C', 'guide_KLF1', 'guide_KMT2A', 'guide_LHX1', 'guide_LYL1', 'guide_MAML2', 'guide_MAP2K3', 'guide_MAP2K6', 'guide_MAP4K3', 'guide_MAP4K5', 'guide_MAP7D1', 'guide_MAPK1', 'guide_MEIS1', 'guide_MIDN', 'guide_NCL', 'guide_NIT1', 'guide_OSR2', 'guide_PLK4', 'guide_POU3F2', 'guide_PRDM1', 'guide_PRTG', 'guide_PTPN1', 'guide_PTPN12', 'guide_PTPN13', 'guide_PTPN9', 'guide_RHOXF2', 'guide_RREB1', 'guide_RUNX1T1', 'guide_S1PR2', 'guide_SAMD1', 'guide_SET', 'guide_SGK1', 'guide_SLC38A2', 'guide_SLC4A1', 'guide_SLC6A9', 'guide_SNAI1', 'guide_SPI1', 'guide_STIL', 'guide_TBX2', 'guide_TBX3', 'guide_TGFBR2', 'guide_TMSB4X', 'guide_TP73', 'guide_TSC22D1', 'guide_UBASH3A', 'guide_UBASH3B', 'guide_ZBTB1', 'guide_ZBTB10', 'guide_ZBTB25', 'guide_ZC3HAV1', 'guide_ZNF318', 'guide_ids', 'n_genes', 'n_genes_by_counts', 'total_counts', 'total_counts_mt', 'pct_counts_mt', 'leiden', 'perturbation_name', 'perturbation_type', 'perturbation_value', 'perturbation_unit'
    var: 'index', 'n_cells', 'mt', 'n_cells_by_counts', 'mean_counts', 'pct_dropout_by_counts', 'total_counts', 'highly_variable', 'means', 'dispersions', 'dispersions_norm', 'ensembl_id', 'ensembl_id_collapsed'
    uns: 'doi', 'hvg', 'leiden', 'neighbors', 'pca', 'preprocessing_nb_link', 'umap', 'log1p'
    obsm: 'X_pca', 'X_umap'
    varm: 'PCs'
    layers: 'counts'
    obsp: 'connectivities', 'distances' has no column attribute 'filter_pass'; tokenizing all cells.
[2025-12-17 21:32:55,429][helical.models.geneformer.geneformer_tokenizer][INFO] - Creating dataset.
[2025-12-17 21:32:55,447][helical.models.geneformer.model][INFO] - Successfully processed the data for Geneformer.
[2025-12-17 21:32:55,447][__main__][INFO] - Extracting embeddings...
[2025-12-17 21:32:55,448][helical.models.geneformer.model][INFO] - Started getting embeddings:
[2025-12-17 21:32:55,448][helical.models.geneformer.geneformer_utils][WARNING] - CLS token present in token dictionary, excluding from average.
[2025-12-17 21:32:55,448][helical.models.geneformer.geneformer_utils][WARNING] - EOS token present in token dictionary, excluding from average.
[2025-12-17 21:32:56,020][helical.models.geneformer.model][INFO] - Finished getting embeddings.
[2025-12-17 21:32:56,020][__main__][INFO] - Extracted embeddings shape: (1000, 512)
[2025-12-17 21:32:56,020][__main__][INFO] - Perturbing gene: SSU72 (type: knockout)
[2025-12-17 21:32:56,020][__main__][WARNING] - Using manual perturbation for SSU72
[2025-12-17 21:32:56,022][py.warnings][WARNING] - /opt/conda/lib/python3.10/site-packages/scipy/sparse/_index.py:151: SparseEfficiencyWarning: Changing the sparsity structure of a csr_matrix is expensive. lil_matrix is more efficient.
  self._set_arrayXarray(i, j, x)

[2025-12-17 21:32:56,023][helical.models.geneformer.model][INFO] - Processing data for Geneformer.
[2025-12-17 21:32:56,373][helical.utils.mapping][INFO] - Mapped 68 / 100 genes to Ensembl IDs.
[2025-12-17 21:32:56,391][helical.models.geneformer.geneformer_tokenizer][INFO] - AnnData object with n_obs × n_vars = 1000 × 100
    obs: 'guide_identity', 'read_count', 'UMI_count', 'coverage', 'gemgroup', 'good_coverage', 'number_of_cells', 'guide_AHR', 'guide_ARID1A', 'guide_ARRDC3', 'guide_ATL1', 'guide_BAK1', 'guide_BCL2L11', 'guide_BCORL1', 'guide_BPGM', 'guide_C19orf26', 'guide_C3orf72', 'guide_CBFA2T3', 'guide_CBL', 'guide_CDKN1A', 'guide_CDKN1B', 'guide_CDKN1C', 'guide_CEBPA', 'guide_CEBPB', 'guide_CEBPE', 'guide_CELF2', 'guide_CITED1', 'guide_CKS1B', 'guide_CLDN6', 'guide_CNN1', 'guide_CNNM4', 'guide_COL1A1', 'guide_COL2A1', 'guide_CSRNP1', 'guide_DLX2', 'guide_DUSP9', 'guide_EGR1', 'guide_ELMSAN1', 'guide_ETS2', 'guide_FEV', 'guide_FOSB', 'guide_FOXA1', 'guide_FOXA3', 'guide_FOXF1', 'guide_FOXL2', 'guide_FOXO4', 'guide_GLB1L2', 'guide_HES7', 'guide_HK2', 'guide_HNF4A', 'guide_HOXA13', 'guide_HOXB9', 'guide_HOXC13', 'guide_IER5L', 'guide_IGDCC3', 'guide_IKZF3', 'guide_IRF1', 'guide_ISL2', 'guide_JUN', 'guide_KIAA1804', 'guide_KIF18B', 'guide_KIF2C', 'guide_KLF1', 'guide_KMT2A', 'guide_LHX1', 'guide_LYL1', 'guide_MAML2', 'guide_MAP2K3', 'guide_MAP2K6', 'guide_MAP4K3', 'guide_MAP4K5', 'guide_MAP7D1', 'guide_MAPK1', 'guide_MEIS1', 'guide_MIDN', 'guide_NCL', 'guide_NIT1', 'guide_OSR2', 'guide_PLK4', 'guide_POU3F2', 'guide_PRDM1', 'guide_PRTG', 'guide_PTPN1', 'guide_PTPN12', 'guide_PTPN13', 'guide_PTPN9', 'guide_RHOXF2', 'guide_RREB1', 'guide_RUNX1T1', 'guide_S1PR2', 'guide_SAMD1', 'guide_SET', 'guide_SGK1', 'guide_SLC38A2', 'guide_SLC4A1', 'guide_SLC6A9', 'guide_SNAI1', 'guide_SPI1', 'guide_STIL', 'guide_TBX2', 'guide_TBX3', 'guide_TGFBR2', 'guide_TMSB4X', 'guide_TP73', 'guide_TSC22D1', 'guide_UBASH3A', 'guide_UBASH3B', 'guide_ZBTB1', 'guide_ZBTB10', 'guide_ZBTB25', 'guide_ZC3HAV1', 'guide_ZNF318', 'guide_ids', 'n_genes', 'n_genes_by_counts', 'total_counts', 'total_counts_mt', 'pct_counts_mt', 'leiden', 'perturbation_name', 'perturbation_type', 'perturbation_value', 'perturbation_unit'
    var: 'index', 'n_cells', 'mt', 'n_cells_by_counts', 'mean_counts', 'pct_dropout_by_counts', 'total_counts', 'highly_variable', 'means', 'dispersions', 'dispersions_norm', 'ensembl_id', 'ensembl_id_collapsed'
    uns: 'doi', 'hvg', 'leiden', 'neighbors', 'pca', 'preprocessing_nb_link', 'umap', 'log1p'
    obsm: 'X_pca', 'X_umap'
    varm: 'PCs'
    layers: 'counts'
    obsp: 'connectivities', 'distances' has no column attribute 'filter_pass'; tokenizing all cells.
[2025-12-17 21:32:56,530][helical.models.geneformer.geneformer_tokenizer][INFO] - Creating dataset.
[2025-12-17 21:32:56,554][helical.models.geneformer.model][INFO] - Successfully processed the data for Geneformer.
[2025-12-17 21:32:56,554][__main__][INFO] - Extracting embeddings...
[2025-12-17 21:32:56,554][helical.models.geneformer.model][INFO] - Started getting embeddings:
[2025-12-17 21:32:56,554][helical.models.geneformer.geneformer_utils][WARNING] - CLS token present in token dictionary, excluding from average.
[2025-12-17 21:32:56,554][helical.models.geneformer.geneformer_utils][WARNING] - EOS token present in token dictionary, excluding from average.
[2025-12-17 21:32:57,252][helical.models.geneformer.model][INFO] - Finished getting embeddings.
[2025-12-17 21:32:57,252][__main__][INFO] - Extracted embeddings shape: (1000, 512)
[2025-12-17 21:32:57,252][__main__][INFO] - Perturbing gene: MRPL20 (type: knockout)
[2025-12-17 21:32:57,252][__main__][WARNING] - Using manual perturbation for MRPL20
[2025-12-17 21:32:57,254][py.warnings][WARNING] - /opt/conda/lib/python3.10/site-packages/scipy/sparse/_index.py:151: SparseEfficiencyWarning: Changing the sparsity structure of a csr_matrix is expensive. lil_matrix is more efficient.
  self._set_arrayXarray(i, j, x)

[2025-12-17 21:32:57,255][helical.models.geneformer.model][INFO] - Processing data for Geneformer.
[2025-12-17 21:32:57,601][helical.utils.mapping][INFO] - Mapped 68 / 100 genes to Ensembl IDs.
[2025-12-17 21:32:57,619][helical.models.geneformer.geneformer_tokenizer][INFO] - AnnData object with n_obs × n_vars = 1000 × 100
    obs: 'guide_identity', 'read_count', 'UMI_count', 'coverage', 'gemgroup', 'good_coverage', 'number_of_cells', 'guide_AHR', 'guide_ARID1A', 'guide_ARRDC3', 'guide_ATL1', 'guide_BAK1', 'guide_BCL2L11', 'guide_BCORL1', 'guide_BPGM', 'guide_C19orf26', 'guide_C3orf72', 'guide_CBFA2T3', 'guide_CBL', 'guide_CDKN1A', 'guide_CDKN1B', 'guide_CDKN1C', 'guide_CEBPA', 'guide_CEBPB', 'guide_CEBPE', 'guide_CELF2', 'guide_CITED1', 'guide_CKS1B', 'guide_CLDN6', 'guide_CNN1', 'guide_CNNM4', 'guide_COL1A1', 'guide_COL2A1', 'guide_CSRNP1', 'guide_DLX2', 'guide_DUSP9', 'guide_EGR1', 'guide_ELMSAN1', 'guide_ETS2', 'guide_FEV', 'guide_FOSB', 'guide_FOXA1', 'guide_FOXA3', 'guide_FOXF1', 'guide_FOXL2', 'guide_FOXO4', 'guide_GLB1L2', 'guide_HES7', 'guide_HK2', 'guide_HNF4A', 'guide_HOXA13', 'guide_HOXB9', 'guide_HOXC13', 'guide_IER5L', 'guide_IGDCC3', 'guide_IKZF3', 'guide_IRF1', 'guide_ISL2', 'guide_JUN', 'guide_KIAA1804', 'guide_KIF18B', 'guide_KIF2C', 'guide_KLF1', 'guide_KMT2A', 'guide_LHX1', 'guide_LYL1', 'guide_MAML2', 'guide_MAP2K3', 'guide_MAP2K6', 'guide_MAP4K3', 'guide_MAP4K5', 'guide_MAP7D1', 'guide_MAPK1', 'guide_MEIS1', 'guide_MIDN', 'guide_NCL', 'guide_NIT1', 'guide_OSR2', 'guide_PLK4', 'guide_POU3F2', 'guide_PRDM1', 'guide_PRTG', 'guide_PTPN1', 'guide_PTPN12', 'guide_PTPN13', 'guide_PTPN9', 'guide_RHOXF2', 'guide_RREB1', 'guide_RUNX1T1', 'guide_S1PR2', 'guide_SAMD1', 'guide_SET', 'guide_SGK1', 'guide_SLC38A2', 'guide_SLC4A1', 'guide_SLC6A9', 'guide_SNAI1', 'guide_SPI1', 'guide_STIL', 'guide_TBX2', 'guide_TBX3', 'guide_TGFBR2', 'guide_TMSB4X', 'guide_TP73', 'guide_TSC22D1', 'guide_UBASH3A', 'guide_UBASH3B', 'guide_ZBTB1', 'guide_ZBTB10', 'guide_ZBTB25', 'guide_ZC3HAV1', 'guide_ZNF318', 'guide_ids', 'n_genes', 'n_genes_by_counts', 'total_counts', 'total_counts_mt', 'pct_counts_mt', 'leiden', 'perturbation_name', 'perturbation_type', 'perturbation_value', 'perturbation_unit'
    var: 'index', 'n_cells', 'mt', 'n_cells_by_counts', 'mean_counts', 'pct_dropout_by_counts', 'total_counts', 'highly_variable', 'means', 'dispersions', 'dispersions_norm', 'ensembl_id', 'ensembl_id_collapsed'
    uns: 'doi', 'hvg', 'leiden', 'neighbors', 'pca', 'preprocessing_nb_link', 'umap', 'log1p'
    obsm: 'X_pca', 'X_umap'
    varm: 'PCs'
    layers: 'counts'
    obsp: 'connectivities', 'distances' has no column attribute 'filter_pass'; tokenizing all cells.
[2025-12-17 21:32:57,748][helical.models.geneformer.geneformer_tokenizer][INFO] - Creating dataset.
[2025-12-17 21:32:57,765][helical.models.geneformer.model][INFO] - Successfully processed the data for Geneformer.
[2025-12-17 21:32:57,765][__main__][INFO] - Extracting embeddings...
[2025-12-17 21:32:57,766][helical.models.geneformer.model][INFO] - Started getting embeddings:
[2025-12-17 21:32:57,766][helical.models.geneformer.geneformer_utils][WARNING] - CLS token present in token dictionary, excluding from average.
[2025-12-17 21:32:57,766][helical.models.geneformer.geneformer_utils][WARNING] - EOS token present in token dictionary, excluding from average.
[2025-12-17 21:32:58,349][helical.models.geneformer.model][INFO] - Finished getting embeddings.
[2025-12-17 21:32:58,349][__main__][INFO] - Extracted embeddings shape: (1000, 512)
[2025-12-17 21:32:58,349][__main__][INFO] - Perturbing gene: AURKAIP1 (type: knockout)
[2025-12-17 21:32:58,349][__main__][WARNING] - Using manual perturbation for AURKAIP1
[2025-12-17 21:32:58,352][py.warnings][WARNING] - /opt/conda/lib/python3.10/site-packages/scipy/sparse/_index.py:151: SparseEfficiencyWarning: Changing the sparsity structure of a csr_matrix is expensive. lil_matrix is more efficient.
  self._set_arrayXarray(i, j, x)

[2025-12-17 21:32:58,352][helical.models.geneformer.model][INFO] - Processing data for Geneformer.
[2025-12-17 21:32:58,700][helical.utils.mapping][INFO] - Mapped 68 / 100 genes to Ensembl IDs.
[2025-12-17 21:32:58,718][helical.models.geneformer.geneformer_tokenizer][INFO] - AnnData object with n_obs × n_vars = 1000 × 100
    obs: 'guide_identity', 'read_count', 'UMI_count', 'coverage', 'gemgroup', 'good_coverage', 'number_of_cells', 'guide_AHR', 'guide_ARID1A', 'guide_ARRDC3', 'guide_ATL1', 'guide_BAK1', 'guide_BCL2L11', 'guide_BCORL1', 'guide_BPGM', 'guide_C19orf26', 'guide_C3orf72', 'guide_CBFA2T3', 'guide_CBL', 'guide_CDKN1A', 'guide_CDKN1B', 'guide_CDKN1C', 'guide_CEBPA', 'guide_CEBPB', 'guide_CEBPE', 'guide_CELF2', 'guide_CITED1', 'guide_CKS1B', 'guide_CLDN6', 'guide_CNN1', 'guide_CNNM4', 'guide_COL1A1', 'guide_COL2A1', 'guide_CSRNP1', 'guide_DLX2', 'guide_DUSP9', 'guide_EGR1', 'guide_ELMSAN1', 'guide_ETS2', 'guide_FEV', 'guide_FOSB', 'guide_FOXA1', 'guide_FOXA3', 'guide_FOXF1', 'guide_FOXL2', 'guide_FOXO4', 'guide_GLB1L2', 'guide_HES7', 'guide_HK2', 'guide_HNF4A', 'guide_HOXA13', 'guide_HOXB9', 'guide_HOXC13', 'guide_IER5L', 'guide_IGDCC3', 'guide_IKZF3', 'guide_IRF1', 'guide_ISL2', 'guide_JUN', 'guide_KIAA1804', 'guide_KIF18B', 'guide_KIF2C', 'guide_KLF1', 'guide_KMT2A', 'guide_LHX1', 'guide_LYL1', 'guide_MAML2', 'guide_MAP2K3', 'guide_MAP2K6', 'guide_MAP4K3', 'guide_MAP4K5', 'guide_MAP7D1', 'guide_MAPK1', 'guide_MEIS1', 'guide_MIDN', 'guide_NCL', 'guide_NIT1', 'guide_OSR2', 'guide_PLK4', 'guide_POU3F2', 'guide_PRDM1', 'guide_PRTG', 'guide_PTPN1', 'guide_PTPN12', 'guide_PTPN13', 'guide_PTPN9', 'guide_RHOXF2', 'guide_RREB1', 'guide_RUNX1T1', 'guide_S1PR2', 'guide_SAMD1', 'guide_SET', 'guide_SGK1', 'guide_SLC38A2', 'guide_SLC4A1', 'guide_SLC6A9', 'guide_SNAI1', 'guide_SPI1', 'guide_STIL', 'guide_TBX2', 'guide_TBX3', 'guide_TGFBR2', 'guide_TMSB4X', 'guide_TP73', 'guide_TSC22D1', 'guide_UBASH3A', 'guide_UBASH3B', 'guide_ZBTB1', 'guide_ZBTB10', 'guide_ZBTB25', 'guide_ZC3HAV1', 'guide_ZNF318', 'guide_ids', 'n_genes', 'n_genes_by_counts', 'total_counts', 'total_counts_mt', 'pct_counts_mt', 'leiden', 'perturbation_name', 'perturbation_type', 'perturbation_value', 'perturbation_unit'
    var: 'index', 'n_cells', 'mt', 'n_cells_by_counts', 'mean_counts', 'pct_dropout_by_counts', 'total_counts', 'highly_variable', 'means', 'dispersions', 'dispersions_norm', 'ensembl_id', 'ensembl_id_collapsed'
    uns: 'doi', 'hvg', 'leiden', 'neighbors', 'pca', 'preprocessing_nb_link', 'umap', 'log1p'
    obsm: 'X_pca', 'X_umap'
    varm: 'PCs'
    layers: 'counts'
    obsp: 'connectivities', 'distances' has no column attribute 'filter_pass'; tokenizing all cells.
[2025-12-17 21:32:58,848][helical.models.geneformer.geneformer_tokenizer][INFO] - Creating dataset.
[2025-12-17 21:32:58,866][helical.models.geneformer.model][INFO] - Successfully processed the data for Geneformer.
[2025-12-17 21:32:58,866][__main__][INFO] - Extracting embeddings...
[2025-12-17 21:32:58,867][helical.models.geneformer.model][INFO] - Started getting embeddings:
[2025-12-17 21:32:58,867][helical.models.geneformer.geneformer_utils][WARNING] - CLS token present in token dictionary, excluding from average.
[2025-12-17 21:32:58,867][helical.models.geneformer.geneformer_utils][WARNING] - EOS token present in token dictionary, excluding from average.
[2025-12-17 21:32:59,434][helical.models.geneformer.model][INFO] - Finished getting embeddings.
[2025-12-17 21:32:59,434][__main__][INFO] - Extracted embeddings shape: (1000, 512)
[2025-12-17 21:32:59,434][__main__][INFO] - Perturbing gene: RPL22 (type: knockout)
[2025-12-17 21:32:59,434][__main__][WARNING] - Using manual perturbation for RPL22
[2025-12-17 21:32:59,436][helical.models.geneformer.model][INFO] - Processing data for Geneformer.
[2025-12-17 21:32:59,783][helical.utils.mapping][INFO] - Mapped 68 / 100 genes to Ensembl IDs.
[2025-12-17 21:32:59,801][helical.models.geneformer.geneformer_tokenizer][INFO] - AnnData object with n_obs × n_vars = 1000 × 100
    obs: 'guide_identity', 'read_count', 'UMI_count', 'coverage', 'gemgroup', 'good_coverage', 'number_of_cells', 'guide_AHR', 'guide_ARID1A', 'guide_ARRDC3', 'guide_ATL1', 'guide_BAK1', 'guide_BCL2L11', 'guide_BCORL1', 'guide_BPGM', 'guide_C19orf26', 'guide_C3orf72', 'guide_CBFA2T3', 'guide_CBL', 'guide_CDKN1A', 'guide_CDKN1B', 'guide_CDKN1C', 'guide_CEBPA', 'guide_CEBPB', 'guide_CEBPE', 'guide_CELF2', 'guide_CITED1', 'guide_CKS1B', 'guide_CLDN6', 'guide_CNN1', 'guide_CNNM4', 'guide_COL1A1', 'guide_COL2A1', 'guide_CSRNP1', 'guide_DLX2', 'guide_DUSP9', 'guide_EGR1', 'guide_ELMSAN1', 'guide_ETS2', 'guide_FEV', 'guide_FOSB', 'guide_FOXA1', 'guide_FOXA3', 'guide_FOXF1', 'guide_FOXL2', 'guide_FOXO4', 'guide_GLB1L2', 'guide_HES7', 'guide_HK2', 'guide_HNF4A', 'guide_HOXA13', 'guide_HOXB9', 'guide_HOXC13', 'guide_IER5L', 'guide_IGDCC3', 'guide_IKZF3', 'guide_IRF1', 'guide_ISL2', 'guide_JUN', 'guide_KIAA1804', 'guide_KIF18B', 'guide_KIF2C', 'guide_KLF1', 'guide_KMT2A', 'guide_LHX1', 'guide_LYL1', 'guide_MAML2', 'guide_MAP2K3', 'guide_MAP2K6', 'guide_MAP4K3', 'guide_MAP4K5', 'guide_MAP7D1', 'guide_MAPK1', 'guide_MEIS1', 'guide_MIDN', 'guide_NCL', 'guide_NIT1', 'guide_OSR2', 'guide_PLK4', 'guide_POU3F2', 'guide_PRDM1', 'guide_PRTG', 'guide_PTPN1', 'guide_PTPN12', 'guide_PTPN13', 'guide_PTPN9', 'guide_RHOXF2', 'guide_RREB1', 'guide_RUNX1T1', 'guide_S1PR2', 'guide_SAMD1', 'guide_SET', 'guide_SGK1', 'guide_SLC38A2', 'guide_SLC4A1', 'guide_SLC6A9', 'guide_SNAI1', 'guide_SPI1', 'guide_STIL', 'guide_TBX2', 'guide_TBX3', 'guide_TGFBR2', 'guide_TMSB4X', 'guide_TP73', 'guide_TSC22D1', 'guide_UBASH3A', 'guide_UBASH3B', 'guide_ZBTB1', 'guide_ZBTB10', 'guide_ZBTB25', 'guide_ZC3HAV1', 'guide_ZNF318', 'guide_ids', 'n_genes', 'n_genes_by_counts', 'total_counts', 'total_counts_mt', 'pct_counts_mt', 'leiden', 'perturbation_name', 'perturbation_type', 'perturbation_value', 'perturbation_unit'
    var: 'index', 'n_cells', 'mt', 'n_cells_by_counts', 'mean_counts', 'pct_dropout_by_counts', 'total_counts', 'highly_variable', 'means', 'dispersions', 'dispersions_norm', 'ensembl_id', 'ensembl_id_collapsed'
    uns: 'doi', 'hvg', 'leiden', 'neighbors', 'pca', 'preprocessing_nb_link', 'umap', 'log1p'
    obsm: 'X_pca', 'X_umap'
    varm: 'PCs'
    layers: 'counts'
    obsp: 'connectivities', 'distances' has no column attribute 'filter_pass'; tokenizing all cells.
[2025-12-17 21:32:59,931][helical.models.geneformer.geneformer_tokenizer][INFO] - Creating dataset.
[2025-12-17 21:32:59,949][helical.models.geneformer.model][INFO] - Successfully processed the data for Geneformer.
[2025-12-17 21:32:59,949][__main__][INFO] - Extracting embeddings...
[2025-12-17 21:32:59,949][helical.models.geneformer.model][INFO] - Started getting embeddings:
[2025-12-17 21:32:59,949][helical.models.geneformer.geneformer_utils][WARNING] - CLS token present in token dictionary, excluding from average.
[2025-12-17 21:32:59,949][helical.models.geneformer.geneformer_utils][WARNING] - EOS token present in token dictionary, excluding from average.
[2025-12-17 21:33:00,508][helical.models.geneformer.model][INFO] - Finished getting embeddings.
[2025-12-17 21:33:00,508][__main__][INFO] - Extracted embeddings shape: (1000, 512)
[2025-12-17 21:33:00,508][__main__][INFO] - Perturbation complete
[2025-12-17 21:33:00,537][__main__][INFO] - Saved outputs for baseline to outputs/outputs/baseline
[2025-12-17 21:33:00,547][__main__][INFO] - 
====================================================================================================
[2025-12-17 21:33:00,547][__main__][INFO] - Running with DISTRIBUTED optimization...
[2025-12-17 21:33:00,547][__main__][INFO] - Using 4 GPUs with DataParallel
[2025-12-17 21:33:00,548][__main__][INFO] - Extracting embeddings...
[2025-12-17 21:33:00,549][helical.models.geneformer.model][INFO] - Started getting embeddings:
[2025-12-17 21:33:00,549][__main__][ERROR] - distributed failed: 'DataParallel' object has no attribute 'bert'
Traceback (most recent call last):
  File "/root/capsule/code/helical-challenge/main.py", line 1125, in run
    perf_metrics, outputs = runner(model, data, adata, genes)
  File "/root/capsule/code/helical-challenge/main.py", line 852, in run_with_distributed
    embeddings = self.extract_embeddings(model, data)
  File "/root/capsule/code/helical-challenge/main.py", line 499, in extract_embeddings
    embeddings = model.get_embeddings(data)
  File "/opt/conda/lib/python3.10/site-packages/helical/models/geneformer/model.py", line 238, in get_embeddings
    embeddings = get_embs(
  File "/opt/conda/lib/python3.10/site-packages/helical/models/geneformer/geneformer_utils.py", line 160, in get_embs
    model_input_size = get_model_input_size(model)
  File "/opt/conda/lib/python3.10/site-packages/helical/models/geneformer/geneformer_utils.py", line 262, in get_model_input_size
    return int(re.split("\(|,", str(model.bert.embeddings.position_embeddings))[1])
  File "/opt/conda/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1940, in __getattr__
    raise AttributeError(
AttributeError: 'DataParallel' object has no attribute 'bert'
[2025-12-17 21:33:00,550][__main__][INFO] - 
====================================================================================================
[2025-12-17 21:33:00,550][__main__][INFO] - COMPARING OUTPUTS TO BASELINE
[2025-12-17 21:33:00,550][__main__][INFO] - ====================================================================================================
[2025-12-17 21:33:00,552][__main__][INFO] - Performance metrics saved to: outputs/performance_metrics_20251217_213300.csv
[2025-12-17 21:33:00,553][__main__][INFO] - 
====================================================================================================
[2025-12-17 21:33:00,553][__main__][INFO] - PERFORMANCE SUMMARY
[2025-12-17 21:33:00,553][__main__][INFO] - ====================================================================================================
[2025-12-17 21:33:00,556][__main__][INFO] - 
     method  runtime_seconds  cpu_percent    memory_mb  gpu_memory_mb  gpu_utilization  throughput_cells_per_sec  num_cells  num_genes_perturbed                   timestamp extra_optimization
0  baseline        12.664914         79.6  6637.476562     153.536621               39                 78.958293       1000                   10  2025-12-17T21:33:00.509900               none

[2025-12-17 21:33:00,557][__main__][INFO] - 
SPEEDUP RELATIVE TO BASELINE:
[2025-12-17 21:33:00,557][__main__][INFO] - --------------------------------------------------
[2025-12-17 21:33:00,557][__main__][INFO] - ====================================================================================================
[2025-12-17 21:33:00,557][__main__][INFO] - 
All outputs saved to: outputs
[2025-12-17 21:33:00,557][__main__][INFO] - 
====================================================================================================
[2025-12-17 21:33:00,557][__main__][INFO] - PIPELINE COMPLETE!
[2025-12-17 21:33:00,557][__main__][INFO] - ====================================================================================================
