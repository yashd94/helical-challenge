[2025-12-23 16:43:30,742][__main__][INFO] - Using device: cuda
[2025-12-23 16:43:30,744][__main__][INFO] - ====================================================================================================
[2025-12-23 16:43:30,744][__main__][INFO] - GENEFORMER PERTURBATION PIPELINE
[2025-12-23 16:43:30,744][__main__][INFO] - ====================================================================================================
[2025-12-23 16:43:30,744][__main__][INFO] - Experiment: geneformer_perturbation_example
[2025-12-23 16:43:30,749][__main__][INFO] - 
Configuration:
reproducibility:
  deterministic: true
  seed: 42
model:
  name: gf-6L-10M-i2048
  batch_size: 16
  device: cuda:0
data:
  pertpy_data_identifier: norman_2019
  condition_filter: control
  save_tokenized_data: true
  gene_names_column: index
  use_raw_counts: false
  preprocess: true
  normalize: false
  filter_genes: true
  min_genes: 100
  min_cells: 3
  max_cells: 100
  max_genes: 50
perturbation:
  gene_list: null
  num_genes: 5
  perturbation_type: knockout
  selection_method: top_expressed
  perturbation_strength: 2.0
  save_perturbed_data: true
optimization:
  methods:
  - quantization
  batching:
    enabled: true
    batch_size_multiplier: 2
  quantization:
    enabled: true
    dtype: fp4
    calibration_data_size: 32
  onnx:
    enabled: true
    use_gpu: true
    precision: FP16
  distributed:
    enabled: true
    backend: nccl
output:
  dir: outputs
  cache_dir: /scratch
  save_outputs: true
  compression: true
  precision: float32
  save_detailed_comparisons: true
  log_level: INFO
  log_to_file: true
  log_file: pipeline.log
hardware:
  device: auto
  mixed_precision: false
  cudnn_benchmark: true
  empty_cache_between_methods: true
experiment:
  name: geneformer_perturbation_example
  tags: []
  notes: ''
advanced:
  compile_model: false
  compile_backend: inductor
  continue_on_error: true
validation:
  min_correlation: 0.95
  max_mse: 0.01
  warn_on_threshold: true
  check_nan: true
  check_inf: true

[2025-12-23 16:43:30,749][__main__][INFO] - Loading Geneformer model...
[2025-12-23 16:43:33,952][helical.models.geneformer.model][INFO] - Model finished initializing.
[2025-12-23 16:43:33,953][helical.models.geneformer.model][INFO] - 'gf-6L-10M-i2048' model is in 'eval' mode, on device 'cuda:0' with embedding mode 'cell'.
[2025-12-23 16:43:33,954][__main__][INFO] - Model loaded: gf-6L-10M-i2048
[2025-12-23 16:43:33,954][__main__][INFO] - Loading data: norman_2019
[2025-12-23 16:43:33,956][__main__][INFO] - Found processed data saved to disk.
[2025-12-23 16:43:34,214][__main__][INFO] - Selected 5 genes using method: top_expressed
[2025-12-23 16:43:34,215][__main__][INFO] - Performing perturbation on 5 genes...
[2025-12-23 16:43:34,216][__main__][INFO] - Perturbed data found in cache. Loading from disk.
[2025-12-23 16:43:34,226][__main__][INFO] - Perturbed data found in cache. Loading from disk.
[2025-12-23 16:43:34,235][__main__][INFO] - Perturbed data found in cache. Loading from disk.
[2025-12-23 16:43:34,244][__main__][INFO] - Perturbed data found in cache. Loading from disk.
[2025-12-23 16:43:34,253][__main__][INFO] - Perturbed data found in cache. Loading from disk.
[2025-12-23 16:43:34,263][__main__][INFO] - Perturbations complete.
[2025-12-23 16:43:34,263][__main__][INFO] - 
====================================================================================================
[2025-12-23 16:43:34,263][__main__][INFO] - Running BASELINE (no optimization)...
[2025-12-23 16:43:34,265][__main__][INFO] - Extracting embeddings...
[2025-12-23 16:43:34,266][helical.models.geneformer.model][INFO] - Started getting embeddings:
[2025-12-23 16:43:43,151][helical.models.geneformer.model][INFO] - Finished getting embeddings.
[2025-12-23 16:43:43,151][__main__][INFO] - Extracted embeddings shape: (10000, 256)
[2025-12-23 16:43:43,151][__main__][INFO] - Extracting embeddings for perturbations on 5 genes...
[2025-12-23 16:43:43,151][__main__][INFO] - Extraxcting embeddings for perturbed: ENO1 (type: knockout)
[2025-12-23 16:43:43,151][__main__][INFO] - Extracting embeddings...
[2025-12-23 16:43:43,151][helical.models.geneformer.model][INFO] - Started getting embeddings:
[2025-12-23 16:43:50,957][helical.models.geneformer.model][INFO] - Finished getting embeddings.
[2025-12-23 16:43:50,957][__main__][INFO] - Extracted embeddings shape: (10000, 256)
[2025-12-23 16:43:50,957][__main__][INFO] - Extraxcting embeddings for perturbed: AURKAIP1 (type: knockout)
[2025-12-23 16:43:50,957][__main__][INFO] - Extracting embeddings...
[2025-12-23 16:43:50,957][helical.models.geneformer.model][INFO] - Started getting embeddings:
[2025-12-23 16:43:58,736][helical.models.geneformer.model][INFO] - Finished getting embeddings.
[2025-12-23 16:43:58,736][__main__][INFO] - Extracted embeddings shape: (10000, 256)
[2025-12-23 16:43:58,736][__main__][INFO] - Extraxcting embeddings for perturbed: HMGN2 (type: knockout)
[2025-12-23 16:43:58,736][__main__][INFO] - Extracting embeddings...
[2025-12-23 16:43:58,736][helical.models.geneformer.model][INFO] - Started getting embeddings:
[2025-12-23 16:44:06,517][helical.models.geneformer.model][INFO] - Finished getting embeddings.
[2025-12-23 16:44:06,518][__main__][INFO] - Extracted embeddings shape: (10000, 256)
[2025-12-23 16:44:06,518][__main__][INFO] - Extraxcting embeddings for perturbed: RPL22 (type: knockout)
[2025-12-23 16:44:06,518][__main__][INFO] - Extracting embeddings...
[2025-12-23 16:44:06,518][helical.models.geneformer.model][INFO] - Started getting embeddings:
[2025-12-23 16:44:14,300][helical.models.geneformer.model][INFO] - Finished getting embeddings.
[2025-12-23 16:44:14,301][__main__][INFO] - Extracted embeddings shape: (10000, 256)
[2025-12-23 16:44:14,301][__main__][INFO] - Extraxcting embeddings for perturbed: RPL11 (type: knockout)
[2025-12-23 16:44:14,301][__main__][INFO] - Extracting embeddings...
[2025-12-23 16:44:14,301][helical.models.geneformer.model][INFO] - Started getting embeddings:
[2025-12-23 16:44:22,096][helical.models.geneformer.model][INFO] - Finished getting embeddings.
[2025-12-23 16:44:22,097][__main__][INFO] - Extracted embeddings shape: (10000, 256)
[2025-12-23 16:44:22,097][__main__][INFO] - Finished getting perturbation results.
[2025-12-23 16:44:24,956][__main__][INFO] - Saved outputs for baseline to outputs/outputs/baseline
[2025-12-23 16:44:24,970][__main__][INFO] - 
====================================================================================================
[2025-12-23 16:44:24,970][__main__][INFO] - Running with QUANTIZATION optimization...
[2025-12-23 16:44:24,970][__main__][WARNING] - Unknown dtype: fp4, using original model
[2025-12-23 16:44:24,972][__main__][INFO] - Extracting embeddings...
[2025-12-23 16:44:24,972][helical.models.geneformer.model][INFO] - Started getting embeddings:
[2025-12-23 16:44:32,819][helical.models.geneformer.model][INFO] - Finished getting embeddings.
[2025-12-23 16:44:32,819][__main__][INFO] - Extracted embeddings shape: (10000, 256)
[2025-12-23 16:44:32,819][__main__][INFO] - Extracting embeddings for perturbations on 5 genes...
[2025-12-23 16:44:32,819][__main__][INFO] - Extraxcting embeddings for perturbed: ENO1 (type: knockout)
[2025-12-23 16:44:32,819][__main__][INFO] - Extracting embeddings...
[2025-12-23 16:44:32,819][helical.models.geneformer.model][INFO] - Started getting embeddings:
[2025-12-23 16:44:40,610][helical.models.geneformer.model][INFO] - Finished getting embeddings.
[2025-12-23 16:44:40,610][__main__][INFO] - Extracted embeddings shape: (10000, 256)
[2025-12-23 16:44:40,610][__main__][INFO] - Extraxcting embeddings for perturbed: AURKAIP1 (type: knockout)
[2025-12-23 16:44:40,610][__main__][INFO] - Extracting embeddings...
[2025-12-23 16:44:40,610][helical.models.geneformer.model][INFO] - Started getting embeddings:
[2025-12-23 16:44:48,390][helical.models.geneformer.model][INFO] - Finished getting embeddings.
[2025-12-23 16:44:48,390][__main__][INFO] - Extracted embeddings shape: (10000, 256)
[2025-12-23 16:44:48,390][__main__][INFO] - Extraxcting embeddings for perturbed: HMGN2 (type: knockout)
[2025-12-23 16:44:48,390][__main__][INFO] - Extracting embeddings...
[2025-12-23 16:44:48,391][helical.models.geneformer.model][INFO] - Started getting embeddings:
[2025-12-23 16:44:56,180][helical.models.geneformer.model][INFO] - Finished getting embeddings.
[2025-12-23 16:44:56,181][__main__][INFO] - Extracted embeddings shape: (10000, 256)
[2025-12-23 16:44:56,181][__main__][INFO] - Extraxcting embeddings for perturbed: RPL22 (type: knockout)
[2025-12-23 16:44:56,181][__main__][INFO] - Extracting embeddings...
[2025-12-23 16:44:56,181][helical.models.geneformer.model][INFO] - Started getting embeddings:
[2025-12-23 16:45:03,955][helical.models.geneformer.model][INFO] - Finished getting embeddings.
[2025-12-23 16:45:03,955][__main__][INFO] - Extracted embeddings shape: (10000, 256)
[2025-12-23 16:45:03,955][__main__][INFO] - Extraxcting embeddings for perturbed: RPL11 (type: knockout)
[2025-12-23 16:45:03,955][__main__][INFO] - Extracting embeddings...
[2025-12-23 16:45:03,955][helical.models.geneformer.model][INFO] - Started getting embeddings:
[2025-12-23 16:45:11,740][helical.models.geneformer.model][INFO] - Finished getting embeddings.
[2025-12-23 16:45:11,740][__main__][INFO] - Extracted embeddings shape: (10000, 256)
[2025-12-23 16:45:11,741][__main__][INFO] - Finished getting perturbation results.
[2025-12-23 16:45:14,580][__main__][INFO] - Saved outputs for quantization to outputs/outputs/quantization
[2025-12-23 16:45:14,594][__main__][INFO] - 
====================================================================================================
[2025-12-23 16:45:14,594][__main__][INFO] - COMPARING OUTPUTS TO BASELINE
[2025-12-23 16:45:14,594][__main__][INFO] - ====================================================================================================
[2025-12-23 16:45:14,594][__main__][INFO] - Comparing baseline vs quantization
[2025-12-23 16:45:15,275][__main__][INFO] - Performance metrics saved to: outputs/performance_metrics_20251223_164515.csv
[2025-12-23 16:45:15,276][__main__][INFO] - Comparison metrics saved to: outputs/comparison_metrics_20251223_164515.csv
[2025-12-23 16:45:15,277][__main__][INFO] - Per-gene comparison saved to: outputs/gene_comparison_baseline_vs_quantization.csv
[2025-12-23 16:45:15,277][__main__][INFO] - 
====================================================================================================
[2025-12-23 16:45:15,277][__main__][INFO] - PERFORMANCE SUMMARY
[2025-12-23 16:45:15,277][__main__][INFO] - ====================================================================================================
[2025-12-23 16:45:15,281][__main__][INFO] - 
         method  runtime_seconds  cpu_percent   memory_mb  gpu_memory_mb  gpu_utilization  throughput_cells_per_sec  num_cells  num_genes_perturbed                   timestamp extra_optimization extra_quantization_dtype
0      baseline        47.833754        100.0   951.28125       9.125000               38                209.057395      10000                    5  2025-12-23T16:44:22.098460               none                      NaN
1  quantization        46.770287        100.0  5923.18750      48.404785               39                213.810960      10000                    5  2025-12-23T16:45:11.742366                NaN                      fp4

[2025-12-23 16:45:15,281][__main__][INFO] - 
SPEEDUP RELATIVE TO BASELINE:
[2025-12-23 16:45:15,282][__main__][INFO] - --------------------------------------------------
[2025-12-23 16:45:15,282][__main__][INFO] - quantization        : 1.02x
[2025-12-23 16:45:15,282][__main__][INFO] - 
====================================================================================================
[2025-12-23 16:45:15,282][__main__][INFO] - OUTPUT COMPARISON SUMMARY
[2025-12-23 16:45:15,282][__main__][INFO] - ====================================================================================================
[2025-12-23 16:45:15,285][__main__][INFO] - 
   method_a      method_b  embedding_pearson  embedding_spearman  embedding_cosine_similarity  embedding_mse  embedding_max_abs_diff  mean_perturbation_correlation  min_perturbation_correlation  max_perturbation_correlation                   timestamp
0  baseline  quantization           0.999996                 1.0                          1.0            0.0                     0.0                       0.999997                      0.999996                      0.999997  2025-12-23T16:45:15.273374

[2025-12-23 16:45:15,285][__main__][INFO] - 
OUTPUT QUALITY ASSESSMENT:
[2025-12-23 16:45:15,285][__main__][INFO] - --------------------------------------------------
[2025-12-23 16:45:15,285][__main__][INFO] - ====================================================================================================
[2025-12-23 16:45:15,285][__main__][INFO] - 
All outputs saved to: outputs
[2025-12-23 16:45:15,285][__main__][INFO] - 
====================================================================================================
[2025-12-23 16:45:15,285][__main__][INFO] - PIPELINE COMPLETE!
[2025-12-23 16:45:15,285][__main__][INFO] - ====================================================================================================
